<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Checklist ‚Äì Praia</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        body {
            font-family: Arial, sans-serif;
            background-image: url('img/fundopraia.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            padding-top: 90px;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.55);
            pointer-events: none;
            z-index: -1;
        }

        .navbar {
            background: white !important;
            box-shadow: 0 2px 8px #0001;
        }

        .navbar-brand {
            font-weight: bold;
            color: #5CAEE3 !important;
        }

        .nav-link {
            font-size: 16px;
            margin-left: 8px;
            color: #555 !important;
        }

        .nav-link:hover {
            color: #5CAEE3 !important;
        }

        .container-praia {
            background: #ffffffcc;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px #0002;
            max-width: 950px;
            margin: auto;
        }

        h1 {
            color: #0077b6;
            font-weight: bold;
        }

        .categoria-box {
            background: #e3f8ff;
            border-left: 6px solid #0096c7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .categoria-box h3 {
            color: #0077b6;
            margin-bottom: 10px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
        }

        .item-row {
            padding: 6px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap:10px;
        }

        .item-left {
            display:flex;
            align-items:center;
            gap:10px;
            flex:1;
        }

        .item-row input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.05);
        }

        .item-actions {
            min-width: 72px;
            text-align: right;
        }

        .orcamento {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 8px #0001;
        }

        .gastos p {
            margin: 4px 0;
            font-size: 16px;
        }

        .total-valor {
            font-size: 18px;
            font-weight: bold;
            color: #0077b6;
        }

        .contador {
            margin-top: 10px;
            font-size: 16px;
            color: #444;
        }

        .footer-frase {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-left: 6px solid #e0a800;
            border-radius: 6px;
            font-size: 15px;
            text-align: center;
        }

        .notas-card {
            width: 260px;
            min-height: 220px;
            background: linear-gradient(180deg, #fff7c2 0%, #fff3a0 100%);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.06);
            position: relative;
            font-size: 14px;
        }
        .notas-card h4 {
            margin: 0 0 8px 0;
            font-weight: 700;
            color: #6b4f00;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .notas-card textarea {
            width: 100%;
            min-height: 140px;
            border: none;
            resize: vertical;
            background: transparent;
            outline: none;
            font-size: 14px;
            color: #222;
        }
        .notas-card .pin {
            position:absolute;
            top: -10px;
            right: 18px;
            width: 22px;
            height: 22px;
            background: radial-gradient(circle at 30% 30%, #fff, #f2f2f2);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        @media (max-width: 980px) {
            .container-praia { padding: 18px; margin-top: 0; }
            .categoria-box h3 { font-size: 18px; flex-direction:column; align-items:flex-start; gap:8px; }
            .item-actions { min-width: 56px; }
            .orcamento-flex { flex-direction: column; gap: 12px; }
            .notas-card { width: 100%; min-height: 140px; }
        }
    </style>
</head>

<body>

<!-- üîê LOGIN PROTEGIDO (SEM DUPLICA√á√ïES) -->
<script type="module">
    import app from "./firebase.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    let isApplyingRemote = false;
    let userPraiaDocRef = null;

    const _localSave = window.saveState;

    window.saveState = async function () {
        try { _localSave(); } catch(e){}
        if (isApplyingRemote) return;

        if (userPraiaDocRef) {
            try {
                const payload = JSON.parse(JSON.stringify(window.state));
                await setDoc(userPraiaDocRef, payload, { merge: true });
            } catch(e){}
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "index.html";
            return;
        }

        const uid = user.uid;
        userPraiaDocRef = doc(db, "usuarios", uid, "praia", "state");

        try {
            const snap = await getDoc(userPraiaDocRef);
            const importedKey = "praia_imported_v1";
            const localRaw = localStorage.getItem("praia_state_v1");

            if (!snap.exists() && localRaw && !localStorage.getItem(importedKey)) {
                await setDoc(userPraiaDocRef, JSON.parse(localRaw));
                localStorage.setItem(importedKey, "1");
            }

            onSnapshot(userPraiaDocRef, (docSnap) => {
                if (!docSnap.exists()) return;

                const remote = docSnap.data();
                try {
                    const local = JSON.parse(localStorage.getItem("praia_state_v1") || "{}");
                    if (JSON.stringify(local) === JSON.stringify(remote)) return;
                } catch(e){}

                isApplyingRemote = true;
                try {
                    window.state = Object.assign({}, window.state, remote);
                    localStorage.setItem("praia_state_v1", JSON.stringify(window.state));
                    if (window.renderAll) window.renderAll();
                } finally {
                    setTimeout(() => isApplyingRemote = false, 200);
                }
            });
        } catch(e){}
    });

    document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => signOut(auth));
        }
    });
</script>
<!-- üîê FIM LOGIN -->

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top custom-navbar bg-white shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <i class="bi bi-journal-check" style="font-size:22px; margin-right:6px;"></i>
            Planejamento
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-house-door"></i> In√≠cio</a></li>
                <li class="nav-item"><a class="nav-link" href="planejamento.html"><i class="bi bi-cash-stack"></i> Planejamento</a></li>
                <li class="nav-item"><a class="nav-link active" href="praia.html"><i class="bi bi-sun"></i> Praia</a></li>
                <li class="nav-item"><a class="nav-link" href="atrasadas.html"><i class="bi bi-exclamation-triangle"></i> Atrasadas</a></li>
                <li class="nav-item"><a class="nav-link" href="calendario.html"><i class="bi bi-calendar3"></i> Calend√°rio</a></li>

                <li class="nav-item ms-3">
                    <button id="logoutBtn" class="btn btn-danger btn-sm">Sair</button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Conte√∫do -->
<div class="container-praia">

    <h1 class="mb-2">Checklist para a Praia üèñÔ∏è</h1>
    <p class="text-muted mb-4">Marque o que j√° estiver na mala ‚Äî tudo ser√° salvo automaticamente.</p>

    <!-- CATEGORIAS -->
    <div id="categorias-root">

        <!-- Roupas -->
        <div class="categoria-box" data-category="roupas">
            <h3>
                <span>üëó Roupas</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1 btn-add-item" data-category="roupas">
                        <i class="bi bi-plus"></i> Adicionar
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-collapse" data-target="roupas-list">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                </div>
            </h3>

            <div id="roupas-list" class="categoria-list"></div>
        </div>

        <!-- Utens√≠lios -->
        <div class="categoria-box" data-category="utensilios">
            <h3>
                <span>üëú Utens√≠lios</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1 btn-add-item" data-category="utensilios">
                        <i class="bi bi-plus"></i> Adicionar
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-collapse" data-target="utensilios-list">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                </div>
            </h3>

            <div id="utensilios-list" class="categoria-list"></div>
        </div>

        <!-- Cuidados pessoais -->
        <div class="categoria-box" data-category="cuidados">
            <h3>
                <span>üß¥ Cuidados pessoais</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1 btn-add-item" data-category="cuidados">
                        <i class="bi bi-plus"></i> Adicionar
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-collapse" data-target="cuidados-list">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                </div>
            </h3>

            <div id="cuidados-list" class="categoria-list"></div>
        </div>

        <!-- Praia -->
        <div class="categoria-box" data-category="praia">
            <h3>
                <span>üå¥ Itens para usar na praia</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1 btn-add-item" data-category="praia">
                        <i class="bi bi-plus"></i> Adicionar
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-collapse" data-target="praia-list">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                </div>
            </h3>

            <div id="praia-list" class="categoria-list"></div>
        </div>

    </div>

    <!-- Or√ßamento + contador + extras + bloco de notas -->
    <div class="orcamento">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-3">Or√ßamento da Viagem</h2>
            <div>
                <button id="addOrcamentoBtn" class="btn btn-sm btn-success">
                    <i class="bi bi-plus-circle"></i> Adicionar item
                </button>
            </div>
        </div>

        <div class="d-flex orcamento-flex" style="gap:20px; align-items:flex-start;">

            <!-- COLUNA 1 -->
            <div style="flex:1; min-width:280px;">
                <div id="orcamento-list" class="gastos mb-3"></div>

                <p class="mt-2 total-valor">Total: <span id="total">R$ 0,00</span></p>

                <hr>

                <div class="d-flex align-items-center gap-3 mb-2">
                    <h2 class="mb-0">Contador para a Viagem</h2>
                    <div>
                        <input id="tripDate" type="date" class="form-control form-control-sm">
                    </div>
                </div>

                <p class="contador">Faltam <strong id="contador">--</strong> dias para a viagem! üèñÔ∏è</p>

                <hr>

                <h2 class="mb-2">Checklist extra</h2>
                <div class="d-flex mb-2 gap-2">
                    <input id="extraInput" class="form-control form-control-sm" placeholder="Adicionar item extra...">
                    <button id="addExtraBtn" class="btn btn-sm btn-primary"><i class="bi bi-plus"></i></button>
                </div>

                <ul class="checklist list-unstyled" id="extra-list"></ul>
            </div>

            <!-- BLOCO DE NOTAS -->
            <div class="notas-card" aria-label="Anota√ß√µes da viagem">
                <div class="pin"></div>
                <h4><i class="bi bi-stickies"></i> Anota√ß√µes</h4>
                <textarea id="notasText" placeholder="Adicionar observa√ß√µes, lembretes ou informa√ß√µes importantes..."></textarea>
                <p style="font-size:12px; color:#6b4f00; margin-top:8px;">Salvando automaticamente ‚Äî sincronizado com o Firebase</p>
            </div>

        </div>
    </div>

    <div class="footer-frase">
        "Viajar √© colecionar mem√≥rias. Que sua ida √† praia seja leve, tranquila e cheia de sol!" ‚òÄÔ∏è
    </div>

</div>

<!-- JS Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- L√ìGICA DA P√ÅGINA -->
<script>
    const STORAGE_KEY = "praia_state_v1";

    const defaultState = {
        tripDate: "2025-12-26",
        categorias: {
            roupas: [
                { id: genId(), text: "Biqu√≠nis / Mai√¥s", checked: false },
                { id: genId(), text: "Sa√≠da de praia", checked: false },
                { id: genId(), text: "Shorts", checked: false },
                { id: genId(), text: "Vestidos leves", checked: false },
                { id: genId(), text: "Pijamas", checked: false },
                { id: genId(), text: "Roupas √≠ntimas", checked: false }
            ],
            utensilios: [
                { id: genId(), text: "Bolsa de praia", checked: false },
                { id: genId(), text: "Toalhas", checked: false },
                { id: genId(), text: "Canga", checked: false },
                { id: genId(), text: "Necessaire", checked: false },
                { id: genId(), text: "Carregador / Powerbank", checked: false },
                { id: genId(), text: "Garrafa t√©rmica", checked: false }
            ],
            cuidados: [
                { id: genId(), text: "Protetor solar", checked: false },
                { id: genId(), text: "Protetor labial", checked: false },
                { id: genId(), text: "Hidratante", checked: false },
                { id: genId(), text: "Shampoo e condicionador", checked: false },
                { id: genId(), text: "Escova de dentes/Pasta", checked: false },
                { id: genId(), text: "Sabonete/Desodorante", checked: false }
            ],
            praia: [
                { id: genId(), text: "√ìculos de sol", checked: false },
                { id: genId(), text: "Chap√©u/Bon√©", checked: false },
                { id: genId(), text: "Chinelo", checked: false },
                { id: genId(), text: "Cooler", checked: false },
                { id: genId(), text: "Caixa t√©rmica", checked: false },
                { id: genId(), text: "Lanches/frutas", checked: false },
                { id: genId(), text: "√Ågua/bebidas", checked: false }
            ]
        },
        extras: [
            { id: genId(), text: "Protetor solar (extra)", checked: false },
            { id: genId(), text: "Roupas praia (extra)", checked: false },
            { id: genId(), text: "Carregadores", checked: false },
            { id: genId(), text: "Rem√©dios", checked: false }
        ],
        orcamento: [
            { id: genId(), label: "Comida", value: 200 },
            { id: genId(), label: "Bebidas", value: 210 },
            { id: genId(), label: "Plantas", value: 150 },
            { id: genId(), label: "Cuidados Pets", value: 100 },
            { id: genId(), label: "Passagens", value: 150 }
        ],
        notas: ""
    };

    // Helpers
    function genId() {
        return "id" + Math.random().toString(36).substr(2, 9);
    }

    function formatBRL(v) {
        return Number(v).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function escapeHtml(str) {
        if (!str) return "";
        return str.replace(/[&<>"']/g, s => ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;"
        }[s]));
    }

    // Estado
    let state = loadState();
    function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return JSON.parse(JSON.stringify(defaultState));
        try { return JSON.parse(raw); }
        catch { return JSON.parse(JSON.stringify(defaultState)); }
    }

    function saveLocalState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    window.saveState = saveLocalState;

    // Renderiza√ß√£o
    function renderAll() {
        renderCategorias();
        renderExtras();
        renderOrcamento();
        renderTripDate();
        renderNotas();
        updateTotalsAndCounter();
    }

    // Categorias
    function renderCategorias() {
        Object.keys(state.categorias).forEach(cat => {
            const container = document.getElementById(cat + "-list");
            container.innerHTML = "";

            state.categorias[cat].forEach(item => {
                const row = document.createElement("div");
                row.className = "item-row";

                row.innerHTML = `
                    <div class="item-left">
                        <input type="checkbox" ${item.checked ? "checked" : ""}>
                        <div contenteditable="true" class="item-text">${escapeHtml(item.text)}</div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger btn-delete-item">
                        <i class="bi bi-trash"></i>
                    </button>
                `;

                container.appendChild(row);

                row.querySelector("input").addEventListener("change", () => {
                    item.checked = !item.checked;
                    saveState();
                });

                row.querySelector(".item-text").addEventListener("input", e => {
                    item.text = e.target.innerText.trim();
                    saveState();
                });

                row.querySelector(".btn-delete-item").addEventListener("click", () => {
                    state.categorias[cat] = state.categorias[cat].filter(x => x.id !== item.id);
                    saveState();
                    renderCategorias();
                });
            });
        });
    }

    // Extras
    function renderExtras() {
        const container = document.getElementById("extra-list");
        container.innerHTML = "";

        state.extras.forEach(item => {
            const li = document.createElement("li");
            li.className = "item-row";

            li.innerHTML = `
                <div class="item-left">
                    <input type="checkbox" ${item.checked ? "checked" : ""}>
                    <div contenteditable="true" class="extra-text">${escapeHtml(item.text)}</div>
                </div>
                <button class="btn btn-sm btn-outline-danger btn-delete-extra">
                    <i class="bi bi-trash"></i>
                </button>
            `;

            container.appendChild(li);

            li.querySelector("input").addEventListener("change", () => {
                item.checked = !item.checked;
                saveState();
            });

            li.querySelector(".extra-text").addEventListener("input", e => {
                item.text = e.target.innerText.trim();
                saveState();
            });

            li.querySelector(".btn-delete-extra").addEventListener("click", () => {
                state.extras = state.extras.filter(x => x.id !== item.id);
                saveState();
                renderExtras();
            });
        });
    }

    // Or√ßamento
    function renderOrcamento() {
        const wrap = document.getElementById("orcamento-list");
        wrap.innerHTML = "";

        state.orcamento.forEach(item => {
            const row = document.createElement("div");
            row.className = "d-flex justify-content-between align-items-center mb-2";

            row.innerHTML = `
                <input class="form-control form-control-sm orc-label" style="flex:1" value="${escapeHtml(item.label)}">
                <input type="number" class="form-control form-control-sm orc-value"
                       style="width:120px; margin-left:8px" value="${item.value}">
                <button class="btn btn-sm btn-outline-danger ms-2 btn-delete-orc">
                    <i class="bi bi-trash"></i>
                </button>
            `;

            wrap.appendChild(row);

            row.querySelector(".orc-label").addEventListener("input", e => {
                item.label = e.target.value;
                saveState();
            });

            row.querySelector(".orc-value").addEventListener("input", e => {
                item.value = parseFloat(e.target.value) || 0;
                saveState();
                updateTotalsAndCounter();
            });

            row.querySelector(".btn-delete-orc").addEventListener("click", () => {
                state.orcamento = state.orcamento.filter(x => x.id !== item.id);
                saveState();
                renderOrcamento();
                updateTotalsAndCounter();
            });
        });

        updateTotalsAndCounter();
    }

    // Trip date
    function renderTripDate() {
        const inp = document.getElementById("tripDate");
        inp.value = state.tripDate;
        inp.addEventListener("change", () => {
            state.tripDate = inp.value;
            saveState();
            updateTotalsAndCounter();
        });
    }

    // Notas
    function renderNotas() {
        const ta = document.getElementById("notasText");
        ta.value = state.notas;
        ta.addEventListener("input", () => {
            state.notas = ta.value;
            saveState();
        });
    }

    // Totais
    function updateTotalsAndCounter() {
        const total = state.orcamento.reduce((s, i) => s + i.value, 0);
        document.getElementById("total").innerText = formatBRL(total);

        const hoje = new Date();
        const viagem = new Date(state.tripDate);

        hoje.setHours(0,0,0,0);
        viagem.setHours(0,0,0,0);

        const diff = viagem - hoje;
        const dias = Math.ceil(diff / (1000 * 60 * 60 * 24));

        const el = document.getElementById("contador");
        el.innerText = dias >= 0 ? dias : `${Math.abs(dias)} dias atr√°s`;
    }

    // Bot√µes
    document.addEventListener("click", e => {
        const addBtn = e.target.closest(".btn-add-item");
        if (addBtn) {
            const cat = addBtn.dataset.category;
            const nome = prompt("Nome do item:");
            if (nome) {
                state.categorias[cat].push({ id: genId(), text: nome, checked: false });
                saveState();
                renderCategorias();
            }
        }
    });

    document.getElementById("addExtraBtn").addEventListener("click", () => {
        const text = document.getElementById("extraInput").value.trim();
        if (!text) return;
        state.extras.push({ id: genId(), text, checked: false });
        document.getElementById("extraInput").value = "";
        saveState();
        renderExtras();
    });

    document.getElementById("addOrcamentoBtn").addEventListener("click", () => {
        state.orcamento.push({ id: genId(), label: "Novo item", value: 0 });
        saveState();
        renderOrcamento();
    });

    // Inicia tudo
    renderAll();
</script>

</body>
</html>
