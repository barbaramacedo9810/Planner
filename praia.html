<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Checklist ‚Äì Praia</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        body {
            font-family: Arial, sans-serif;
            background-image: url('img/fundopraia.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            padding-top: 90px;
            position: relative;
        }

        /* camada semitransparente para melhorar leitura */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.55);
            pointer-events: none;
            z-index: -1;
        }

        /* NAVBAR */
        .navbar {
            background: white !important;
            box-shadow: 0 2px 8px #0001;
        }

        .navbar-brand {
            font-weight: bold;
            color: #5CAEE3 !important;
        }

        .nav-link {
            font-size: 16px;
            margin-left: 8px;
            color: #555 !important;
        }

        .nav-link:hover {
            color: #5CAEE3 !important;
        }

        .container-praia {
            background: #ffffffcc;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px #0002;
            max-width: 950px;
            margin: auto;
        }

        h1 {
            color: #0077b6;
            font-weight: bold;
        }

        .categoria-box {
            background: #e3f8ff;
            border-left: 6px solid #0096c7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .categoria-box h3 {
            color: #0077b6;
            margin-bottom: 10px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
        }

        .item-row {
            padding: 6px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap:10px;
        }

        .item-left {
            display:flex;
            align-items:center;
            gap:10px;
            flex:1;
        }

        .item-row input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.05);
        }

        .item-actions {
            min-width: 72px;
            text-align: right;
        }

        /* Or√ßamento */
        .orcamento {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 8px #0001;
        }

        .gastos p {
            margin: 4px 0;
            font-size: 16px;
        }

        .total-valor {
            font-size: 18px;
            font-weight: bold;
            color: #0077b6;
        }

        .contador {
            margin-top: 10px;
            font-size: 16px;
            color: #444;
        }

        .footer-frase {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-left: 6px solid #e0a800;
            border-radius: 6px;
            font-size: 15px;
            text-align: center;
        }

        /* Post-it style (anota√ß√µes) */
        .notas-card {
            width: 260px;
            min-height: 220px;
            background: linear-gradient(180deg, #fff7c2 0%, #fff3a0 100%);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.06);
            position: relative;
            font-size: 14px;
        }
        .notas-card h4 {
            margin: 0 0 8px 0;
            font-weight: 700;
            color: #6b4f00;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .notas-card textarea {
            width: 100%;
            min-height: 140px;
            border: none;
            resize: vertical;
            background: transparent;
            outline: none;
            font-size: 14px;
            color: #222;
        }
        .notas-card .pin {
            position:absolute;
            top: -10px;
            right: 18px;
            width: 22px;
            height: 22px;
            background: radial-gradient(circle at 30% 30%, #fff, #f2f2f2);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        /* responsive adjustments */
        @media (max-width: 980px) {
            .container-praia { padding: 18px; margin-top: 0; }
            .categoria-box h3 { font-size: 18px; flex-direction:column; align-items:flex-start; gap:8px; }
            .item-actions { min-width: 56px; }
            /* notas drop under orcamento on small */
            .orcamento-flex { flex-direction: column; gap: 12px; }
            .notas-card { width: 100%; min-height: 140px; }
        }
    </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top custom-navbar bg-white shadow-sm">
    <div class="container-fluid">

        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <i class="bi bi-journal-check" style="font-size:22px; margin-right:6px;"></i>
            Planejamento
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto">

                <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-house-door"></i> In√≠cio</a></li>
                <li class="nav-item"><a class="nav-link" href="planejamento.html"><i class="bi bi-cash-stack"></i> Planejamento</a></li>
                <li class="nav-item"><a class="nav-link active" href="praia.html"><i class="bi bi-sun"></i> Praia</a></li>
                <li class="nav-item"><a class="nav-link" href="atrasadas.html"><i class="bi bi-exclamation-triangle"></i> Atrasadas</a></li>
                <li class="nav-item"><a class="nav-link" href="calendario.html"><i class="bi bi-calendar3"></i> Calend√°rio</a></li>

                <li class="nav-item ms-3">
                    <button id="logoutBtn" class="btn btn-danger btn-sm">Sair</button>
                </li>

            </ul>
        </div>

    </div>
</nav>

<!-- Conte√∫do -->
<div class="container-praia">

    <h1 class="mb-2">Checklist para a Praia üèñÔ∏è</h1>
    <p class="text-muted mb-4">Marque o que j√° estiver na mala ‚Äî tudo ser√° salvo automaticamente.</p>

    <!-- CATEGORIAS -->
    <div id="categorias-root">

        <!-- Roupas -->
        <div class="categoria-box" data-category="roupas">
            <h3>
                <span>üëó Roupas</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1 btn-add-item" data-category="roupas">
                        <i class="bi bi-plus"></i> Adicionar
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-collapse" data-target="roupas-list">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                </div>
            </h3>

            <div id="roupas-list" class="categoria-list">
                <!-- items renderizados via JS -->
            </div>
        </div>

        <!-- Utens√≠lios -->
        <div class="categoria-box" data-category="utensilios">
            <h3>
                <span>üëú Utens√≠lios</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1 btn-add-item" data-category="utensilios">
                        <i class="bi bi-plus"></i> Adicionar
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-collapse" data-target="utensilios-list">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                </div>
            </h3>

            <div id="utensilios-list" class="categoria-list"></div>
        </div>

        <!-- Cuidados pessoais -->
        <div class="categoria-box" data-category="cuidados">
            <h3>
                <span>üß¥ Cuidados pessoais</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1 btn-add-item" data-category="cuidados">
                        <i class="bi bi-plus"></i> Adicionar
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-collapse" data-target="cuidados-list">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                </div>
            </h3>

            <div id="cuidados-list" class="categoria-list"></div>
        </div>

        <!-- Praia -->
        <div class="categoria-box" data-category="praia">
            <h3>
                <span>üå¥ Itens para usar na praia</span>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1 btn-add-item" data-category="praia">
                        <i class="bi bi-plus"></i> Adicionar
                    </button>
                    <button class="btn btn-sm btn-outline-secondary btn-collapse" data-target="praia-list">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                </div>
            </h3>

            <div id="praia-list" class="categoria-list"></div>
        </div>

    </div>

    <!-- Or√ßamento, contador e checklist extra (com bloco de notas ao lado) -->
    <div class="orcamento">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-3">Or√ßamento da Viagem</h2>
            <div>
                <button id="addOrcamentoBtn" class="btn btn-sm btn-success">
                    <i class="bi bi-plus-circle"></i> Adicionar item
                </button>
            </div>
        </div>

        <!-- FLEX: left = or√ßamento + contador + extras / right = notas -->
        <div class="d-flex orcamento-flex" style="gap:20px; align-items:flex-start;">

            <div style="flex:1; min-width:280px;">
                <div id="orcamento-list" class="gastos mb-3">
                    <!-- renderizado dinamicamente -->
                </div>

                <p class="mt-2 total-valor">Total: <span id="total">R$ 0,00</span></p>

                <hr>

                <div class="d-flex align-items-center gap-3 mb-2">
                    <h2 class="mb-0">Contador para a Viagem</h2>
                    <div>
                        <input id="tripDate" type="date" class="form-control form-control-sm" style="display:inline-block; width:auto;">
                    </div>
                </div>
                <p class="contador">Faltam <strong id="contador">--</strong> dias para a viagem! üèñÔ∏è</p>

                <hr>

                <h2 class="mb-2">Checklist extra</h2>
                <div class="d-flex mb-2 gap-2">
                    <input id="extraInput" class="form-control form-control-sm" placeholder="Adicionar item extra...">
                    <button id="addExtraBtn" class="btn btn-sm btn-primary"><i class="bi bi-plus"></i></button>
                </div>
                <ul class="checklist list-unstyled" id="extra-list"></ul>
            </div>

            <!-- NOTAS (post-it style) -->
            <div class="notas-card" aria-label="Anota√ß√µes da viagem">
                <div class="pin" title="Anota√ß√µes"></div>
                <h4><i class="bi bi-stickies me-1"></i> Anota√ß√µes</h4>
                <textarea id="notasText" placeholder="Adicionar observa√ß√µes, lembretes ou informa√ß√µes importantes..."></textarea>
                <p style="font-size:12px; color:#6b4f00; margin-top:8px;">Salvando automaticamente ‚Äî sincronizado com o Firebase</p>
            </div>

        </div>

    </div>

    <div class="footer-frase">
        "Viajar √© colecionar mem√≥rias. Que sua ida √† praia seja leve, tranquila e cheia de sol!" ‚òÄÔ∏è
    </div>

</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /*
      Praia page - dynamic checklist + budget + countdown
      Data persisted to localStorage under key "praia_state_v1" (fallback) and synchronized with Firestore when logged in.

      Structure kept locally (e usado para upload/import inicial):
      {
        tripDate: "2025-12-26",
        categorias: { roupas: [...], utensilios: [...], cuidados: [...], praia: [...] },
        extras: [...],
        orcamento: [...],
        notas: "texto..."
      }
    */

    const STORAGE_KEY = "praia_state_v1";

    const defaultState = {
        tripDate: "2025-12-26",
        categorias: {
            roupas: [
                { id: genId(), text: "Biqu√≠nis / Mai√¥s", checked: false },
                { id: genId(), text: "Sa√≠da de praia", checked: false },
                { id: genId(), text: "Shorts", checked: false },
                { id: genId(), text: "Vestidos leves", checked: false },
                { id: genId(), text: "Pijamas", checked: false },
                { id: genId(), text: "Roupas √≠ntimas", checked: false }
            ],
            utensilios: [
                { id: genId(), text: "Bolsa de praia", checked: false },
                { id: genId(), text: "Toalhas", checked: false },
                { id: genId(), text: "Canga", checked: false },
                { id: genId(), text: "Necessaire", checked: false },
                { id: genId(), text: "Carregador / Powerbank", checked: false },
                { id: genId(), text: "Garrafa t√©rmica", checked: false }
            ],
            cuidados: [
                { id: genId(), text: "Protetor solar", checked: false },
                { id: genId(), text: "Protetor labial", checked: false },
                { id: genId(), text: "Hidratante", checked: false },
                { id: genId(), text: "Shampoo e condicionador", checked: false },
                { id: genId(), text: "Escova de dentes/Pasta", checked: false },
                { id: genId(), text: "Sabonete/Desodorante", checked: false }
            ],
            praia: [
                { id: genId(), text: "√ìculos de sol", checked: false },
                { id: genId(), text: "Chap√©u/Bon√©", checked: false },
                { id: genId(), text: "Chinelo", checked: false },
                { id: genId(), text: "Cooler", checked: false },
                { id: genId(), text: "Caixa t√©rmica", checked: false },
                { id: genId(), text: "Lanches/frutas", checked: false },
                { id: genId(), text: "√Ågua/bebidas", checked: false }
            ]
        },
        extras: [
            { id: genId(), text: "Protetor solar (extra)", checked: false },
            { id: genId(), text: "Roupas praia (extra)", checked: false },
            { id: genId(), text: "Carregadores", checked: false },
            { id: genId(), text: "Rem√©dios", checked: false }
        ],
        orcamento: [
            { id: genId(), label: "Comida", value: 200 },
            { id: genId(), label: "Bebidas", value: 210 },
            { id: genId(), label: "Plantas", value: 150 },
            { id: genId(), label: "Cuidados Pets", value: 100 },
            { id: genId(), label: "Passagens", value: 150 }
        ],
        notas: ""
    };

    // ---------- helpers ----------
    function genId() {
        return 'id' + Math.random().toString(36).slice(2,9);
    }

    function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return JSON.parse(JSON.stringify(defaultState));
        try {
            return JSON.parse(raw);
        } catch(e) {
            console.error("Erro lendo localStorage:", e);
            return JSON.parse(JSON.stringify(defaultState));
        }
    }

    // save local only (keeps API stable for other callbacks).
    function saveLocalState() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch(e) {
            console.error("Erro salvando estado local:", e);
        }
    }

    // we'll override global saveState later to sync with Firestore
    window.saveState = saveLocalState;

    function formatBRL(v) {
        return Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    // ---------- state ----------
    let state = loadState();

    // ---------- rendering ----------
    const categories = Object.keys(state.categorias);

    function renderAll() {
        renderCategorias();
        renderExtras();
        renderOrcamento();
        renderTripDate();
        renderNotas();
        updateTotalsAndCounter();
    }

    function renderCategorias() {
        categories.forEach(cat => {
            const container = document.getElementById(cat + "-list");
            if (!container) return;
            container.innerHTML = "";

            state.categorias[cat].forEach(item => {
                const row = document.createElement("div");
                row.className = "item-row";
                row.dataset.id = item.id;

                row.innerHTML = `
                <div class="item-left">
                    <input type="checkbox" class="me-2 item-checkbox" ${item.checked ? "checked": ""}>
                    <div contenteditable="true" class="item-text">${escapeHtml(item.text)}</div>
                </div>

                <div class="item-actions">
                    <button class="btn btn-sm btn-outline-danger btn-delete-item"><i class="bi bi-trash"></i></button>
                </div>
            `;
                container.appendChild(row);

                // events
                const checkbox = row.querySelector(".item-checkbox");
                checkbox.addEventListener("change", (e) => {
                    item.checked = checkbox.checked;
                    saveState();
                });

                const textDiv = row.querySelector(".item-text");
                textDiv.addEventListener("input", () => {
                    item.text = textDiv.innerText.trim();
                    saveState();
                });

                row.querySelector(".btn-delete-item").addEventListener("click", () => {
                    const idx = state.categorias[cat].findIndex(x => x.id === item.id);
                    if (idx > -1) {
                        state.categorias[cat].splice(idx,1);
                        saveState();
                        renderCategorias();
                    }
                });
            });
        });
    }

    function renderExtras() {
        const list = document.getElementById("extra-list");
        if (!list) return;
        list.innerHTML = "";

        state.extras.forEach(item => {
            const li = document.createElement("li");
            li.className = "item-row";
            li.innerHTML = `
            <div class="item-left">
                <input type="checkbox" class="me-2 extra-checkbox" ${item.checked ? "checked": ""}>
                <div contenteditable="true" class="extra-text">${escapeHtml(item.text)}</div>
            </div>
            <div class="item-actions">
                <button class="btn btn-sm btn-outline-danger btn-delete-extra"><i class="bi bi-trash"></i></button>
            </div>
        `;
            list.appendChild(li);

            li.querySelector(".extra-checkbox").addEventListener("change", () => {
                item.checked = li.querySelector(".extra-checkbox").checked;
                saveState();
            });

            li.querySelector(".extra-text").addEventListener("input", () => {
                item.text = li.querySelector(".extra-text").innerText.trim();
                saveState();
            });

            li.querySelector(".btn-delete-extra").addEventListener("click", () => {
                const idx = state.extras.findIndex(x => x.id === item.id);
                if (idx > -1) {
                    state.extras.splice(idx,1);
                    saveState();
                    renderExtras();
                }
            });
        });
    }

    function renderOrcamento() {
        const wrap = document.getElementById("orcamento-list");
        if (!wrap) return;
        wrap.innerHTML = "";

        state.orcamento.forEach(item => {
            const row = document.createElement("div");
            row.className = "d-flex justify-content-between align-items-center mb-2";
            row.dataset.id = item.id;

            row.innerHTML = `
            <div class="me-3" style="flex:1;">
                <input class="form-control form-control-sm orc-label" value="${escapeHtml(item.label)}" />
            </div>
            <div style="width:140px; display:flex; gap:8px; align-items:center;">
                <input type="number" min="0" step="0.01" class="form-control form-control-sm orc-value" value="${Number(item.value).toFixed(2)}" />
                <button class="btn btn-sm btn-outline-danger btn-delete-orc"><i class="bi bi-trash"></i></button>
            </div>
        `;

            wrap.appendChild(row);

            const labelInp = row.querySelector(".orc-label");
            const valueInp = row.querySelector(".orc-value");
            labelInp.addEventListener("input", () => {
                item.label = labelInp.value.trim();
                saveState();
                renderOrcamento(); // update maybe label changes
            });
            valueInp.addEventListener("input", () => {
                item.value = parseFloat(valueInp.value) || 0;
                saveState();
                updateTotalsAndCounter();
            });
            row.querySelector(".btn-delete-orc").addEventListener("click", () => {
                const idx = state.orcamento.findIndex(x => x.id === item.id);
                if (idx > -1) {
                    state.orcamento.splice(idx,1);
                    saveState();
                    renderOrcamento();
                    updateTotalsAndCounter();
                }
            });
        });

        updateTotalsAndCounter();
    }

    function renderTripDate() {
        const inp = document.getElementById("tripDate");
        if (!inp) return;
        inp.value = state.tripDate || "";
        inp.addEventListener("change", () => {
            state.tripDate = inp.value;
            saveState();
            updateTotalsAndCounter();
        });
    }

    function renderNotas() {
        const ta = document.getElementById("notasText");
        if (!ta) return;
        ta.value = state.notas || "";
    }

    function updateTotalsAndCounter() {
        // or√ßamento total
        const total = state.orcamento.reduce((s,i) => s + Number(i.value || 0), 0);
        const totalEl = document.getElementById("total");
        if (totalEl) totalEl.innerText = formatBRL(total);

        // contador
        const contadorEl = document.getElementById("contador");
        const trip = state.tripDate ? new Date(state.tripDate) : null;
        if (!contadorEl) return;
        if (!trip || isNaN(trip.getTime())) {
            contadorEl.innerText = "‚Äî";
        } else {
            const hoje = new Date();
            // normalize to midnight
            trip.setHours(0,0,0,0);
            hoje.setHours(0,0,0,0);
            const diffMs = trip - hoje;
            const diasRaw = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            if (diasRaw > 0) contadorEl.innerText = diasRaw;
            else if (diasRaw === 0) contadorEl.innerText = "0 (hoje!)";
            else contadorEl.innerText = Math.abs(diasRaw) + " dias atr√°s";
        }
    }

    // ---------- actions (DOM delegation) ----------
    document.addEventListener("click", (e) => {
        // add item buttons
        if (e.target.closest(".btn-add-item")) {
            const btn = e.target.closest(".btn-add-item");
            const cat = btn.dataset.category;
            const text = prompt("Nome do novo item:");
            if (text && text.trim() !== "") {
                state.categorias[cat].push({ id: genId(), text: text.trim(), checked: false });
                saveState();
                renderCategorias();
            }
        }

        // collapse toggles
        if (e.target.closest(".btn-collapse")) {
            const btn = e.target.closest(".btn-collapse");
            const target = btn.dataset.target;
            const el = document.getElementById(target);
            if (!el) return;
            const showing = el.style.display !== "none";
            el.style.display = showing ? "none" : "";
            btn.querySelector("i").classList.toggle("bi-chevron-up", !showing);
            btn.querySelector("i").classList.toggle("bi-chevron-down", showing);
        }
    });

    // add extra item
    const addExtraBtn = document.getElementById("addExtraBtn");
    if (addExtraBtn) {
        addExtraBtn.addEventListener("click", () => {
            const text = document.getElementById("extraInput").value.trim();
            if (!text) return;
            state.extras.push({ id: genId(), text, checked: false });
            document.getElementById("extraInput").value = "";
            saveState();
            renderExtras();
        });
    }

    // add budget row
    const addOrcamentoBtn = document.getElementById("addOrcamentoBtn");
    if (addOrcamentoBtn) {
        addOrcamentoBtn.addEventListener("click", () => {
            state.orcamento.push({ id: genId(), label: "Novo item", value: 0 });
            saveState();
            renderOrcamento();
        });
    }

    // notas autosave (with small debounce)
    (function setupNotasAutosave(){
        const ta = document.getElementById("notasText");
        if (!ta) return;
        let timeout = null;
        ta.addEventListener("input", () => {
            state.notas = ta.value;
            // debounce 600ms
            if (timeout) clearTimeout(timeout);
            timeout = setTimeout(() => {
                saveState();
            }, 600);
        });
    })();

    // initialize lists in DOM (defensive)
    function ensureListsExist() {
        categories.forEach(cat => {
            const el = document.getElementById(cat + "-list");
            if (!el) {
                const parent = document.querySelector(`[data-category="${cat}"]`);
                if (parent) {
                    const div = document.createElement("div");
                    div.id = cat + "-list";
                    parent.appendChild(div);
                }
            }
        });
    }
    ensureListsExist();

    // escape text for safety in contenteditable where used for innerHTML
    function escapeHtml(str) {
        if (!str && str !== 0) return "";
        return String(str).replace(/[&<>"']/g, function (s) {
            return ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[s];
        });
    }

    // initial render
    renderAll();

</script>

<!-- üîê PROTE√á√ÉO DE LOGIN + LOGOUT + SYNC FIRESTORE -->
<script type="module">
    import app from "./firebase.js"; // seu arquivo existente (assume export default app)
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    // Flags to avoid write loops
    let isApplyingRemote = false;

    // reference to Firestore document (preparado quando usu√°rio fizer login)
    let userPraiaDocRef = null;

    // Keep original local saver
    const _localSave = window.saveState;

    // Override saveState to also sync to Firestore when logged in
    window.saveState = async function() {
        // always save local first
        try {
            _localSave();
        } catch (err) {
            console.error("Erro salvando local:", err);
        }

        // if we're currently applying remote update, do not push back
        if (isApplyingRemote) return;

        // if user doc ref available, push to Firestore
        if (userPraiaDocRef) {
            try {
                // Deep clone state to avoid references
                const payload = JSON.parse(JSON.stringify(window.state));
                await setDoc(userPraiaDocRef, payload, { merge: true });
            } catch (err) {
                console.error("Erro salvando no Firestore:", err);
            }
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            // redireciona para login se necess√°rio (como antes)
            window.location.href = "login.html";
            return;
        }

        const uid = user.uid;
        // definir ref: /usuarios/{uid}/praia/state
        userPraiaDocRef = doc(db, "usuarios", uid, "praia", "state");

        // check remote doc existence
        try {
            const snap = await getDoc(userPraiaDocRef);
            const importedFlagKey = "praia_imported_v1";

            const localRaw = localStorage.getItem("praia_state_v1");
            const localHas = !!localRaw;

            // if remote does NOT exist but local exists and not yet imported -> upload local
            if (!snap.exists() && localHas && !localStorage.getItem(importedFlagKey)) {
                try {
                    const localState = JSON.parse(localRaw);
                    await setDoc(userPraiaDocRef, localState);
                    // mark imported so we don't re-upload on next login
                    localStorage.setItem(importedFlagKey, "1");
                    console.log("Local state imported to Firestore (first-time).");
                } catch (err) {
                    console.error("Erro importando local para Firestore:", err);
                }
            }

            // now attach real-time listener to keep local in sync with Firestore
            onSnapshot(userPraiaDocRef, (docSnap) => {
                if (!docSnap.exists()) return;
                const remote = docSnap.data();
                // If remote is identical to local, skip
                try {
                    const local = JSON.parse(localStorage.getItem("praia_state_v1") || "{}");
                    const same = JSON.stringify(local) === JSON.stringify(remote);
                    if (same) return;
                } catch (e) {
                    // ignore
                }

                // Apply remote state locally (prevent re-upload loop)
                isApplyingRemote = true;
                try {
                    // Merge remote into window.state (so we keep structure)
                    window.state = Object.assign({}, window.state, remote);
                    // ensure categorias exists
                    if (!window.state.categorias) window.state.categorias = {};
                    // save local and re-render
                    localStorage.setItem("praia_state_v1", JSON.stringify(window.state));
                    // render
                    if (typeof window.renderAll === "function") window.renderAll();
                } catch (err) {
                    console.error("Erro aplicando estado remoto:", err);
                } finally {
                    // small delay to avoid races
                    setTimeout(() => { isApplyingRemote = false; }, 200);
                }
            }, (err) => {
                console.error("Erro no onSnapshot:", err);
            });

        } catch (err) {
            console.error("Erro checando doc Firestore:", err);
        }
    });

    // logout button behavior (mantive)
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
            try {
                await signOut(auth);
            } catch (err) {
                console.error("Erro ao deslogar:", err);
            }
        });
    }

</script>

</body>
</html>
