<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Planejamento Financeiro</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Ícones Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Material Icons (opção E escolhida) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Seu CSS externo -->
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* Pequenos ajustes locais para inputs na tabela (mantém layout atual) */
        .table td input[type="number"]{
            width: 110px;
        }
        .table td input[type="text"]{
            width: 100%;
            min-width: 120px;
            border: none;
            background: transparent;
            padding: 0;
        }
        .table td input[type="text"]:focus,
        .table td input[type="number"]:focus {
            outline: none;
            box-shadow: none;
        }
        .checkbox-center {
            display:flex;
            justify-content:center;
            align-items:center;
        }

        /* Evita que imagens decorativas capturem cliques */
        .resumo-img,
        .menininha-img {
            pointer-events: none;
        }

        /* coluna do ícone check minimalista */
        .col-check-icon {
            font-size: 20px;
            text-align: center;
            color: #1aab2a;
        }

        /* melhora aparencia do input dentro da celula */
        .table td .form-control-sm {
            padding: .25rem .5rem;
            height: calc(1.5em + .5rem);
        }

        /* responsividade - garante overflow da tabela */
        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body>

<!-- Proteção de login -->
<script type="module">
    import app from "./firebase.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const auth = getAuth(app);
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "login.html";
        }
    });
</script>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top custom-navbar bg-white shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <i class="bi bi-journal-check" style="font-size:22px; margin-right:6px;"></i>
            Planejamento
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-house-door"></i> Início</a></li>
                <li class="nav-item"><a class="nav-link active" href="planejamento.html"><i class="bi bi-cash-stack"></i> Planejamento</a></li>
                <li class="nav-item"><a class="nav-link" href="praia.html"><i class="bi bi-sun"></i> Praia</a></li>
                <li class="nav-item"><a class="nav-link" href="atrasadas.html"><i class="bi bi-exclamation-triangle"></i> Atrasadas</a></li>
                <li class="nav-item"><a class="nav-link" href="calendario.html"><i class="bi bi-calendar3"></i> Calendário</a></li>

                <li class="nav-item ms-3">
                    <button id="logoutBtn" class="btn btn-danger btn-sm">Sair</button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- CONTEÚDO PRINCIPAL -->
<div class="main-wrapper">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Planejamento Financeiro</h1>

        <div class="d-flex align-items-center gap-2">
            <label class="mb-0 me-1">Planejamento —</label>
            <select id="monthSelect" class="form-select form-select-sm" style="width:220px;"></select>

            <button id="newMonthBtn" class="btn btn-outline-secondary btn-sm">Novo mês</button>
            <button id="duplicateBtn" class="btn btn-outline-primary btn-sm">Duplicar</button>
        </div>
    </div>

    <!-- RESUMO -->
    <div id="resumoWrapper" class="resumo-box shadow-sm mb-4 p-3 rounded">
        <div class="resumo-content">
            <p>Total de Saída: <strong id="resumoSaida">R$ 0,00</strong></p>
            <p>Total de Rendas: <strong id="resumoRendas">R$ 0,00</strong></p>
            <p>Saldo Final: <strong id="saldoFinal">R$ 0,00</strong></p>
        </div>

        <img src="img/planejamento.png" alt="Porquinho" class="resumo-img">
    </div>

    <div class="row mt-4">
        <!-- ESQUERDA - TABELA DÉBITOS -->
        <div class="col-md-8">
            <div class="d-flex justify-content-between mb-2">
                <h4 class="fw-bold">Débitos</h4>
                <button class="btn btn-primary btn-sm" id="addDebitoBtn">
                    <i class="bi bi-plus-circle"></i> Adicionar Débito
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered shadow-sm" id="tabelaDebitos">
                    <thead>
                    <tr>
                        <th>Descrição</th>
                        <th style="width:120px">Valor (R$)</th>
                        <th style="width:120px">Falta (R$)</th>
                        <th style="width:80px" class="text-center">Pago</th>
                        <th style="width:60px" class="col-check-icon">✔</th>
                        <th style="width:60px"></th>
                    </tr>
                    </thead>
                    <tbody></tbody>

                    <tfoot>
                    <tr class="table-warning fw-bold">
                        <td>Total</td>
                        <td id="totalSaida" colspan="5">R$ 0,00</td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- DIREITA - RENDAS -->
        <div class="col-md-4">

            <div class="card renda-card shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="fw-bold d-flex justify-content-between align-items-center">
                        Rendas
                        <button class="btn btn-success btn-sm" id="addRendaBtn">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </h4>

                    <div id="rendasLista"></div>

                    <p class="fw-bold mt-3">Total de Entradas:
                        <span id="totalRendas" class="text-success">R$ 0,00</span>
                    </p>
                </div>
            </div>

            <!-- AFIRMAÇÕES -->
            <div class="affirm-box mt-3">
                <h5 class="affirm-title">✨ Afirmações Positivas</h5>
                <div class="affirm-list">
                    <div class="affirm-item">"A prosperidade começa na mente. Cultive pensamentos positivos."</div>
                    <div class="affirm-item">"Sou merecedora de toda a abundância que o universo tem para me oferecer."</div>
                    <div class="affirm-item">"A prosperidade flui livremente em minha vida com leveza."</div>
                </div>

                <img src="img/planejamento1.png" alt="Menininha" class="menininha-img">
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- SCRIPT PRINCIPAL -->
<script type="module">
    import app, { db } from "./firebase.js";
    import {
        getAuth,
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
        collection,
        doc,
        getDoc,
        getDocs,
        setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /* -------------------------
       UTILITÁRIOS E ESTADO
    ------------------------- */
    const auth = getAuth(app);

    const MONTH_NAMES = [
        "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
        "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
    ];

    function labelFromKey(key){
        if(!key) return "";
        const [y,m] = key.split("-");
        return `${MONTH_NAMES[Number(m)-1] || m} / ${y}`;
    }

    function prevMonthKey(key) {
        let [y,m] = key.split("-").map(Number);
        m--;
        if (m < 1) { m = 12; y--; }
        return `${y}-${String(m).padStart(2,"0")}`;
    }

    function formatBRL(value){
        const n = Number(value) || 0;
        return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    let usuarioId = null;
    let availableMonths = [];
    let currentMonthKey = null;
    let debitos = [];
    let rendas = [];

    /* DOM */
    const tabelaBody = document.querySelector("#tabelaDebitos tbody");
    const rendasLista = document.getElementById("rendasLista");
    const monthSelect = document.getElementById("monthSelect");
    const newMonthBtn = document.getElementById("newMonthBtn");
    const duplicateBtn = document.getElementById("duplicateBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const resumoSaidaEl = document.getElementById("resumoSaida");
    const resumoRendasEl = document.getElementById("resumoRendas");
    const saldoFinalEl = document.getElementById("saldoFinal");
    const totalSaidaFooter = document.getElementById("totalSaida");
    const totalRendasEl = document.getElementById("totalRendas");

    /* FIRESTORE PATH HELPERS (caminho correto em profundidade) */
    const colMeses = (uid) => collection(db, "usuarios", uid, "planejamento", "meses");
    const docMes = (uid, key) => doc(db, "usuarios", uid, "planejamento", "meses", key);

    /* -------------------------
       LÊ LISTA DE MESES
    ------------------------- */
    async function carregarListaMeses() {
        try {
            const snap = await getDocs(colMeses(usuarioId));
            availableMonths = [];
            snap.forEach(d => availableMonths.push(d.id));
            availableMonths.sort();
            atualizarSelect();
        } catch (err) {
            console.error("Erro ao listar meses:", err);
        }
    }

    function atualizarSelect(){
        const previous = monthSelect.value;
        monthSelect.innerHTML = "";

        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "";
        monthSelect.appendChild(placeholder);

        availableMonths.forEach(key => {
            const op = document.createElement("option");
            op.value = key;
            op.textContent = labelFromKey(key);
            monthSelect.appendChild(op);
        });

        if (currentMonthKey && availableMonths.includes(currentMonthKey)) {
            monthSelect.value = currentMonthKey;
        } else if (availableMonths.length > 0) {
            monthSelect.value = availableMonths[availableMonths.length - 1];
        } else {
            monthSelect.value = "";
        }

        if (monthSelect.value && monthSelect.value !== previous) {
            carregarMes(monthSelect.value).catch(console.error);
        }
    }

    /* -------------------------
       CARREGA MÊS (sem sobrescrever wrapper visual)
    ------------------------- */
    async function carregarMes(key) {
        try {
            if (!key) {
                debitos = [];
                rendas = [];
                renderDebitos();
                renderRendas();
                atualizarTotais();
                currentMonthKey = null;
                return;
            }

            const snap = await getDoc(docMes(usuarioId, key));
            if (snap.exists()) {
                const data = snap.data();
                debitos = Array.isArray(data.debitos) ? data.debitos : [];
                // normaliza estrutura de cada débito
                debitos = debitos.map(d => {
                    return {
                        nome: d && typeof d.nome !== "undefined" ? d.nome : "",
                        valor: Number(d && d.valor ? d.valor : 0),
                        falta: typeof d?.falta !== "undefined" ? Number(d.falta) : Number(d && d.valor ? d.valor : 0),
                        pago: Boolean(d && d.pago) || (Number(d?.falta ?? d?.valor ?? 0) === 0)
                    };
                });
                rendas = Array.isArray(data.rendas) ? data.rendas : [];
            } else {
                debitos = [];
                rendas = [];
            }

            currentMonthKey = key;
            atualizarSelect();
            renderDebitos();
            renderRendas();
            atualizarTotais();
        } catch (err) {
            console.error("Erro ao carregar mês:", err);
        }
    }

    /* -------------------------
       SALVA MÊS
    ------------------------- */
    async function salvarMes() {
        if (!usuarioId || !currentMonthKey) return;
        try {
            await setDoc(docMes(usuarioId, currentMonthKey), {
                debitos,
                rendas,
                updatedAt: new Date().toISOString()
            });
            // atualiza lista sem sobrescrever seleção atual
            await carregarListaMeses();
        } catch (err) {
            console.error("Erro ao salvar mês:", err);
        }
    }

    /* -------------------------
       CRIAR NOVO MÊS (prompt), valida e salva
    ------------------------- */
    async function criarNovoMes() {
        const mes = prompt("Informe o mês (YYYY-MM):");
        if (!mes) return;
        if (!/^\d{4}-\d{2}$/.test(mes)) {
            alert("Formato inválido. Use YYYY-MM.");
            return;
        }

        debitos = [];
        rendas = [];
        currentMonthKey = mes;

        await salvarMes();
        await carregarMes(mes);
        alert("Mês criado com sucesso.");
    }

    /* -------------------------
       DUPLICAR MÊS
    ------------------------- */
    async function duplicarMes() {
        const destino = prompt("Para qual mês deseja duplicar? (YYYY-MM):", currentMonthKey || "");
        if (!destino) return;
        if (!/^\d{4}-\d{2}$/.test(destino)) { alert("Formato inválido."); return; }

        const origem = prevMonthKey(destino);
        try {
            const snap = await getDoc(docMes(usuarioId, origem));
            if (!snap.exists()) { alert("Mês anterior não existe."); return; }
            const data = snap.data();
            debitos = JSON.parse(JSON.stringify(data.debitos || []));
            rendas = JSON.parse(JSON.stringify(data.rendas || []));
            currentMonthKey = destino;

            await salvarMes();
            await carregarMes(destino);
            alert("Mês duplicado com sucesso.");
        } catch (err) {
            console.error("Erro ao duplicar:", err);
            alert("Erro ao duplicar mês. Veja console.");
        }
    }

    /* -------------------------
       RENDERIZAÇÃO DÉBITOS (tabela)
    ------------------------- */
    function renderDebitos() {
        tabelaBody.innerHTML = "";
        debitos.forEach((d, i) => {
            // garantia de campos
            d.nome = d.nome || "";
            d.valor = Number(d.valor || 0);
            d.falta = typeof d.falta !== "undefined" ? Number(d.falta) : d.valor;
            d.pago = Boolean(d.pago);

            const tr = document.createElement("tr");

            // note: escapeHtml para evitar injeção em value
            tr.innerHTML = `
                <td>
                    <input type="text" class="form-control form-control-sm" value="${escapeHtml(String(d.nome))}"
                           oninput="window.__edDeb(${i}, 'nome', this.value)">
                </td>

                <td class="align-middle">
                    <input type="number" class="form-control form-control-sm" step="0.01" min="0" value="${(Number(d.valor)||0).toFixed(2)}"
                        onchange="window.__edDeb(${i}, 'valor', this.value)">
                </td>

                <td class="align-middle">
                    <input type="number" class="form-control form-control-sm" step="0.01" min="0" value="${(Number(d.falta)||0).toFixed(2)}"
                        onchange="window.__edDeb(${i}, 'falta', this.value)">
                </td>

                <td class="checkbox-center align-middle">
                    <input type="checkbox" ${d.pago ? "checked" : ""} onchange="window.__togglePago(${i}, this.checked)">
                </td>

                <td class="col-check-icon align-middle">
                    ${d.pago ? '<span class="material-icons" aria-hidden="true" title="Pago">done</span>' : ''}
                </td>

                <td class="text-center align-middle">
                    <button class="btn btn-danger btn-sm" onclick="window.__rmDeb(${i})"><i class="bi bi-trash"></i></button>
                </td>
            `;
            tabelaBody.appendChild(tr);
        });

        atualizarTotais();
    }

    /* -------------------------
       RENDER RENDAS (mantido)
    ------------------------- */
    function renderRendas() {
        rendasLista.innerHTML = "";
        rendas.forEach((r, i) => {
            const div = document.createElement("div");
            div.className = "d-flex justify-content-between align-items-center mb-2";
            const nome = (r && r.nome) ? r.nome : "";
            const valor = Number(r && r.valor ? r.valor : 0).toFixed(2);
            div.innerHTML = `
                <div contenteditable="true" oninput="window.__edRen(${i}, 'nome', this.innerText)">${escapeHtml(nome)}</div>
                <div>
                    <span contenteditable="true" oninput="window.__edRen(${i}, 'valor', this.innerText)">${valor}</span>
                    <button class="btn btn-danger btn-sm ms-2" onclick="window.__rmRen(${i})"><i class="bi bi-trash"></i></button>
                </div>
            `;
            rendasLista.appendChild(div);
        });
        atualizarTotais();
    }

    /* -------------------------
       ESCAPE
    ------------------------- */
    function escapeHtml(str) {
        return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;");
    }

    /* -------------------------
       OPERACOES INLINE DÉBITOS
    ------------------------- */
    window.__edDeb = (i, campo, v) => {
        if (!debitos[i]) return;
        if (campo === "valor" || campo === "falta") {
            const num = parseFloat(String(v).replace(",", ".")) || 0;
            debitos[i][campo] = num;

            // regras:
            // - se falta === 0 => pago true
            // - se falta > 0 => pago false
            if (campo === "falta") {
                debitos[i].pago = Number(num) === 0;
            }

            // não permitir falta > valor
            if (debitos[i].falta > debitos[i].valor) {
                debitos[i].falta = debitos[i].valor;
            }

            // se alterou valor e falta era maior que novo valor, ajustar falta
            if (campo === "valor" && debitos[i].falta > debitos[i].valor) {
                debitos[i].falta = debitos[i].valor;
                if (debitos[i].falta === 0) debitos[i].pago = true;
            }

        } else {
            debitos[i][campo] = v;
        }

        // re-render e salva
        renderDebitos();
        salvarMes();
    };

    window.__togglePago = (i, checked) => {
        if (!debitos[i]) return;
        debitos[i].pago = Boolean(checked);
        if (debitos[i].pago) {
            debitos[i].falta = 0;
        } else {
            // se desmarcou, assume que falta é o valor total
            debitos[i].falta = Number(debitos[i].valor || 0);
        }
        renderDebitos();
        salvarMes();
    };

    window.__rmDeb = (i) => {
        debitos.splice(i, 1);
        renderDebitos();
        salvarMes();
    };

    /* -------------------------
       RENDAS INLINE
    ------------------------- */
    window.__edRen = (i, c, v) => {
        if (!rendas[i]) return;
        if (c === "valor") v = parseFloat(String(v).replace(",", ".")) || 0;
        rendas[i][c] = v;
        atualizarTotais();
        salvarMes();
    };

    window.__rmRen = (i) => {
        rendas.splice(i, 1);
        salvarMes();
        renderRendas();
    };

    /* -------------------------
       TOTAIS
    ------------------------- */
    function atualizarTotais() {
        // total de saída = soma do (valor - falta) = efetivamente pago
        const totalSaidaVal = debitos.reduce((acc, d) => {
            const valor = Number(d.valor || 0);
            const falta = Number(d.falta || 0);
            const pago = valor - falta;
            return acc + Math.max(0, Number(pago));
        }, 0);

        const totalRendasVal = rendas.reduce((acc, r) => acc + (Number(r.valor) || 0), 0);
        const saldoVal = totalRendasVal - totalSaidaVal;

        totalSaidaFooter.innerText = formatBRL(totalSaidaVal);
        totalRendasEl.innerText = formatBRL(totalRendasVal);
        resumoSaidaEl.innerText = formatBRL(totalSaidaVal);
        resumoRendasEl.innerText = formatBRL(totalRendasVal);
        saldoFinalEl.innerText = formatBRL(saldoVal);

        saldoFinalEl.classList.toggle("text-danger", saldoVal < 0);
        saldoFinalEl.classList.toggle("text-success", saldoVal >= 0);
    }

    /* -------------------------
       EVENTOS BOTOES
    ------------------------- */
    document.getElementById("addDebitoBtn").onclick = () => {
        // por padrão, nova conta não está paga e falta == valor
        const novo = { nome: "Novo Débito", valor: 0, falta: 0, pago: true };
        debitos.push(novo);
        renderDebitos();
        salvarMes();
    };

    document.getElementById("addRendaBtn").onclick = () => {
        rendas.push({ nome: "Nova Renda", valor: 0 });
        renderRendas();
        salvarMes();
    };

    newMonthBtn.onclick = criarNovoMes;
    duplicateBtn.onclick = duplicarMes;

    logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = "login.html";
    };

    monthSelect.onchange = async () => {
        const key = monthSelect.value;
        if (!key) return;
        await salvarMes();
        await carregarMes(key);
    };

    /* -------------------------
       LOGIN FLOW (onAuth)
       cria mês atual automaticamente se não houver meses
    ------------------------- */
    onAuthStateChanged(auth, async user => {
        if (!user) return;
        usuarioId = user.uid;

        await carregarListaMeses();

        if (availableMonths.length === 0) {
            const hoje = new Date();
            const y = hoje.getFullYear();
            const m = String(hoje.getMonth() + 1).padStart(2, "0");
            const chave = `${y}-${m}`;

            debitos = [];
            rendas = [];
            currentMonthKey = chave;

            // salva o documento para o usuário (cria subcoleção automaticamente)
            await salvarMes();
            await carregarListaMeses();
        }

        // seleciona o último mês (mais recente)
        currentMonthKey = availableMonths[availableMonths.length - 1];
        if (currentMonthKey) {
            await carregarMes(currentMonthKey);
        }
    });

</script>
</body>
</html>
