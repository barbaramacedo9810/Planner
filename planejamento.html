<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Planejamento Financeiro</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- √çcones Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- SEU CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

<!-- üîê PROTE√á√ÉO DE LOGIN (colocada no topo) -->
<script type="module">
    import app, { db } from "./firebase.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const auth = getAuth(app);

    // redireciona para login caso n√£o esteja logado
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "login.html";
        }
    });

    // Expondo alguns m√©todos para uso posterior caso queira (opcional)
    window.__PLAN_AUTH = auth;
    window.__PLAN_DB = db;
    window.__PLAN_FS = { collection, getDocs, doc, getDoc, setDoc };
</script>
<!-- üîê FIM PROTE√á√ÉO -->

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top custom-navbar bg-white shadow-sm">
    <div class="container-fluid">

        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <i class="bi bi-journal-check" style="font-size:22px; margin-right:6px;"></i>
            Planejamento
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto">

                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="bi bi-house-door"></i> In√≠cio
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link active" href="planejamento.html">
                        <i class="bi bi-cash-stack"></i> Planejamento
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="praia.html">
                        <i class="bi bi-sun"></i> Praia
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="atrasadas.html">
                        <i class="bi bi-exclamation-triangle"></i> Atrasadas
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="calendario.html">
                        <i class="bi bi-calendar3"></i> Calend√°rio
                    </a>
                </li>

                <li class="nav-item ms-3">
                    <button id="logoutBtn" class="btn btn-danger btn-sm">Sair</button>
                </li>

            </ul>
        </div>

    </div>
</nav>

<!-- CONTE√öDO PRINCIPAL -->
<div class="main-wrapper mt-5">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Planejamento Financeiro</h1>

        <!-- seletor de m√™s + duplicar -->
        <div class="d-flex align-items-center gap-2">
            <label class="mb-0 me-1">Planejamento ‚Äî</label>
            <select id="monthSelect" class="form-select form-select-sm" style="width:220px;"></select>

            <button id="newMonthBtn" class="btn btn-outline-secondary btn-sm" title="Criar m√™s vazio">
                Novo m√™s
            </button>

            <button id="duplicateBtn" class="btn btn-outline-primary btn-sm" title="Duplicar m√™s anterior">
                Duplicar
            </button>
        </div>
    </div>

    <!-- RESUMO -->
    <div class="resumo-box shadow-sm mb-4">
        <p>Total de Sa√≠da: <strong id="resumoSaida">R$ 0,00</strong></p>
        <p>Total de Rendas: <strong id="resumoRendas">R$ 0,00</strong></p>
        <p>Saldo Final: <strong id="saldoFinal">R$ 0,00</strong></p>

        <img src="img/planejamento.png" class="img-resumo-decor">
    </div>

    <div class="row mt-4">

        <!-- ESQUERDA - TABELA -->
        <div class="col-md-8">

            <div class="d-flex justify-content-between mb-2">
                <h4 class="fw-bold">D√©bitos</h4>
                <button class="btn btn-primary btn-sm" id="addDebitoBtn">
                    <i class="bi bi-plus-circle"></i> Adicionar D√©bito
                </button>
            </div>

            <table class="table table-bordered shadow-sm" id="tabelaDebitos">
                <thead>
                <tr>
                    <th>D√©bito</th>
                    <th>Valor (R$)</th>
                    <th></th>
                </tr>
                </thead>
                <tbody></tbody>

                <tfoot>
                <tr class="table-warning fw-bold">
                    <td>Total</td>
                    <td id="totalSaida">R$ 0,00</td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>

        <!-- DIREITA - RENDAS + AFIRMA√á√ïES -->
        <div class="col-md-4">

            <div class="card renda-card shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="fw-bold d-flex justify-content-between">
                        Rendas
                        <button class="btn btn-success btn-sm" id="addRendaBtn">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </h4>

                    <div id="rendasLista"></div>

                    <!-- Total -->
                    <p class="fw-bold mt-3">Total de Entradas:
                        <span id="totalRendas" class="text-success">R$ 0,00</span>
                    </p>
                </div>
            </div>

            <!-- QUADRADO ROSA -->
            <div class="affirm-box mt-3">
                <h5 class="affirm-title">‚ú® Afirma√ß√µes Positivas</h5>

                <div class="affirm-item">
                    "A prosperidade come√ßa na mente. Cultive pensamentos positivos e veja sua realidade se transformar."
                </div>

                <div class="affirm-item">
                    "Sou merecedora de toda a abund√¢ncia que o universo tem para me oferecer."
                </div>

                <div class="affirm-item">
                    "A prosperidade flui livremente em minha vida com leveza."
                </div>

                <img src="img/planejamento1.png" class="img-affirm-decor">
            </div>

        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- ======================================================= -->
<!-- SCRIPT COMPLETO - TUDO DIN√ÇMICO                         -->
<!-- ======================================================= -->
<script type="module">
    import app, { db } from "./firebase.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
        collection,
        getDocs,
        doc,
        getDoc,
        setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const auth = getAuth(app);

    // ------------------ helpers de data/m√™s ------------------
    const MONTH_NAMES = [
        "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
        "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
    ];

    function monthKeyFromDate(d) {
        const y = d.getFullYear();
        const m = (d.getMonth() + 1).toString().padStart(2,'0');
        return `${y}-${m}`; // ex. 2025-12
    }

    function labelFromMonthKey(key) {
        const [y,m] = key.split("-");
        const idx = parseInt(m,10)-1;
        return `${MONTH_NAMES[idx]} / ${y}`;
    }

    function prevMonthKey(key) {
        const [y,m] = key.split("-");
        let year = parseInt(y,10), month = parseInt(m,10);
        month--;
        if (month < 1) { month = 12; year--; }
        return `${year}-${String(month).padStart(2,'0')}`;
    }

    // ------------------ estado local (UI) ------------------
    // estrutura que ser√° salva por m√™s:
    // { debitos: [{nome,valor}], rendas: [{nome,valor}], updatedAt: "... (opcional)" }
    let debitos = [
        { nome: "Luz", valor: 300 },
        { nome: "Cart√£o", valor: 800 },
        { nome: "Internet", valor: 120 },
        { nome: "Ra√ß√£o Pets", valor: 300 },
        { nome: "Netflix", valor: 22.90 },
        { nome: "Disney", valor: 27.90 },
        { nome: "Xbox", valor: 59.90 },
        { nome: "V√¥", valor: 150 },
        { nome: "Amigo", valor: 150 },
        { nome: "Pai", valor: 50 },
        { nome: "Tia", valor: 100 },
        { nome: "Tio", valor: 70 },
        { nome: "Plantas", valor: 180 },
        { nome: "Faculdade", valor: 600 },
        { nome: "Mercado", valor: 600 },
        { nome: "Carne", valor: 200 }
    ];

    let rendas = [
        { nome: "Renda 1", valor: 1320 },
        { nome: "Renda 2", valor: 1055 },
        { nome: "Renda 3", valor: 830 },
        { nome: "Renda 4", valor: 280 }
    ];

    const tabelaBody = document.querySelector("#tabelaDebitos tbody");
    const listaRendas = document.getElementById("rendasLista");
    const monthSelect = document.getElementById("monthSelect");
    const newMonthBtn = document.getElementById("newMonthBtn");
    const duplicateBtn = document.getElementById("duplicateBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    // Firestore helpers
    let usuarioId = null;
    const PATH_PLANEJAMENTO = ["planejamento","meses"]; // under usuarios/{uid}/planejamento/meses/{docId}

    function collectionRefForMonths(uid) {
        // usuarios/{uid}/planejamento/meses
        return collection(db, "usuarios", uid, ...PATH_PLANEJAMENTO);
    }

    function docRefForMonth(uid, monthKey) {
        // usuarios/{uid}/planejamento/meses/{monthKey}
        return doc(db, "usuarios", uid, ...PATH_PLANEJAMENTO, monthKey);
    }

    // ------------------ render functions ------------------
    function atualizarTabela() {
        tabelaBody.innerHTML = "";

        debitos.forEach((item, index) => {
            let tr = document.createElement("tr");

            tr.innerHTML = `
            <td contenteditable="true" oninput="window.__editarDebito(${index}, 'nome', this.innerText)">
                ${item.nome}
            </td>

            <td contenteditable="true" oninput="window.__editarDebito(${index}, 'valor', this.innerText)">
                ${Number(item.valor).toFixed(2)}
            </td>

            <td class="text-center">
                <button class="btn btn-danger btn-sm" onclick="window.__removerDebito(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
            tabelaBody.appendChild(tr);
        });

        atualizarTotais();
    }

    function atualizarRendas() {
        listaRendas.innerHTML = "";

        rendas.forEach((item, index) => {
            let div = document.createElement("div");
            div.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

            div.innerHTML = `
            <div contenteditable="true" oninput="window.__editarRenda(${index}, 'nome', this.innerText)">
                ${item.nome}
            </div>

            <div class="d-flex align-items-center">
                <span contenteditable="true" oninput="window.__editarRenda(${index}, 'valor', this.innerText)">
                    ${Number(item.valor).toFixed(2)}
                </span>

                <button class="btn btn-danger btn-sm ms-2" onclick="window.__removerRenda(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
            listaRendas.appendChild(div);
        });

        atualizarTotais();
    }

    function atualizarTotais() {
        let totalDebitos = debitos.reduce((t, d) => t + Number(d.valor || 0), 0);
        let totalRenda = rendas.reduce((t, r) => t + Number(r.valor || 0), 0);
        let saldo = totalRenda - totalDebitos;

        document.getElementById("totalSaida").innerText = "R$ " + totalDebitos.toFixed(2).replace(".", ",");
        document.getElementById("resumoSaida").innerText = "R$ " + totalDebitos.toFixed(2).replace(".", ",");
        document.getElementById("totalRendas").innerText = "R$ " + totalRenda.toFixed(2).replace(".", ",");
        document.getElementById("resumoRendas").innerText = "R$ " + totalRenda.toFixed(2).replace(".", ",");
        document.getElementById("saldoFinal").innerText = "R$ " + saldo.toFixed(2).replace(".", ",");
    }

    // Expondo pequenos utilit√°rios (usados nos contenteditable)
    window.__editarDebito = function(i, campo, valor) {
        if (campo === "valor") valor = valor.replace(",", ".");
        if (campo === "valor") valor = parseFloat(valor) || 0;
        debitos[i][campo] = valor;
        marcarAlteracao();
        atualizarTotais();
    };
    window.__removerDebito = function(i) {
        debitos.splice(i,1);
        marcarAlteracao();
        atualizarTabela();
    };
    window.__editarRenda = function(i, campo, valor) {
        if (campo === "valor") valor = valor.replace(",", ".");
        if (campo === "valor") valor = parseFloat(valor) || 0;
        rendas[i][campo] = valor;
        marcarAlteracao();
        atualizarTotais();
    };
    window.__removerRenda = function(i) {
        rendas.splice(i,1);
        marcarAlteracao();
        atualizarRendas();
    };

    document.getElementById("addDebitoBtn").onclick = () => {
        debitos.push({ nome: "Novo D√©bito", valor: 0 });
        marcarAlteracao();
        atualizarTabela();
    };

    document.getElementById("addRendaBtn").onclick = () => {
        rendas.push({ nome: "Nova Renda", valor: 0 });
        marcarAlteracao();
        atualizarRendas();
    };

    // ---------- month list & selection / CRUD ----------
    let availableMonths = []; // array of monthKey strings
    let currentMonthKey = null; // ex: "2025-12"
    let autoSaveInterval = null;
    let lastChangeTimestamp = 0;

    function getCurrentMonthKeyDefault() {
        return monthKeyFromDate(new Date());
    }

    async function listMonthsFromFirestore(uid) {
        const col = collectionRefForMonths(uid);
        const snap = await getDocs(col);
        const months = [];
        snap.forEach(d => months.push(d.id));
        months.sort(); // lexicographic sorts ISO yyyy-mm correctly
        return months;
    }

    function populateMonthSelect() {
        monthSelect.innerHTML = "";
        // Add option to create arbitrary month using a "YYYY-MM" format input (we also have buttons)
        availableMonths.forEach(key => {
            const opt = document.createElement("option");
            opt.value = key;
            opt.textContent = labelFromMonthKey(key);
            monthSelect.appendChild(opt);
        });

        // if currentMonthKey not in availableMonths, add it as selectable (but not saved yet)
        if (currentMonthKey && !availableMonths.includes(currentMonthKey)) {
            const opt = document.createElement("option");
            opt.value = currentMonthKey;
            opt.textContent = labelFromMonthKey(currentMonthKey) + " (novo)";
            opt.selected = true;
            monthSelect.prepend(opt);
        }

        // select currentMonthKey
        if (currentMonthKey) {
            monthSelect.value = currentMonthKey;
        }
    }

    async function loadMonth(uid, monthKey) {
        // load from firestore; if not exists, leave defaults (but clear if "new month empty" desired)
        const ref = docRefForMonth(uid, monthKey);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
            // New month: Op√ß√£o A ‚Äî come√ßa vazio
            debitos = [];
            rendas = [];
        } else {
            const data = snap.data();
            debitos = Array.isArray(data.debitos) ? data.debitos : [];
            rendas = Array.isArray(data.rendas) ? data.rendas : [];
        }

        currentMonthKey = monthKey;
        // update UI label display in select
        populateMonthSelect();
        atualizarTabela();
        atualizarRendas();

        // ensure autosave is pointed to this doc (handled by autosave using currentMonthKey)
        marcarAlteracao();
    }

    async function saveMonthToFirestore(uid, monthKey) {
        if (!uid || !monthKey) return;
        const payload = {
            debitos,
            rendas,
            updatedAt: new Date().toISOString()
        };
        const ref = docRefForMonth(uid, monthKey);
        await setDoc(ref, payload, { merge: true });
        // refresh months list (if new created)
        availableMonths = await listMonthsFromFirestore(uid);
        populateMonthSelect();
    }

    // create a new month empty (and select it)
    async function createNewMonth(uid, monthKey) {
        // if monthKey omitted, open prompt for YYYY-MM
        let mk = monthKey;
        if (!mk) {
            // default to next month
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            mk = monthKeyFromDate(d);
            const userInput = prompt("Informe o m√™s no formato YYYY-MM (ex: 2026-01) ou deixe:", mk);
            if (!userInput) return null;
            // basic validation
            if (!/^\d{4}-\d{2}$/.test(userInput)) {
                alert("Formato inv√°lido. Use YYYY-MM.");
                return null;
            }
            mk = userInput;
        }

        // create empty doc
        debitos = [];
        rendas = [];
        currentMonthKey = mk;
        await saveMonthToFirestore(uid, mk);
        populateMonthSelect();
        atualizarTabela();
        atualizarRendas();
        return mk;
    }

    // duplicate previous month into the currently selected month (overwrites current)
    async function duplicatePreviousMonth(uid, targetMonthKey) {
        if (!targetMonthKey) {
            alert("Selecione primeiro o m√™s de destino no seletor.");
            return;
        }
        const sourceKey = prevMonthKey(targetMonthKey);
        // get source doc
        const srcRef = docRefForMonth(uid, sourceKey);
        const srcSnap = await getDoc(srcRef);
        if (!srcSnap.exists()) {
            alert(`N√£o foi encontrado m√™s anterior (${labelFromMonthKey(sourceKey)}) para duplicar.`);
            return;
        }
        const data = srcSnap.data();
        debitos = Array.isArray(data.debitos) ? JSON.parse(JSON.stringify(data.debitos)) : [];
        rendas = Array.isArray(data.rendas) ? JSON.parse(JSON.stringify(data.rendas)) : [];
        currentMonthKey = targetMonthKey;
        await saveMonthToFirestore(uid, targetMonthKey);
        populateMonthSelect();
        atualizarTabela();
        atualizarRendas();
        alert(`M√™s ${labelFromMonthKey(sourceKey)} duplicado para ${labelFromMonthKey(targetMonthKey)}.`);
    }

    // mark that the UI changed (used to trigger autosave)
    function marcarAlteracao() {
        lastChangeTimestamp = Date.now();
    }

    // autosave loop (1s), saves to current selected month if user logged
    function startAutoSaveLoop() {
        if (autoSaveInterval) clearInterval(autoSaveInterval);
        autoSaveInterval = setInterval(async () => {
            // if no recent changes, skip to reduce writes (but still periodically)
            // We'll save if lastChangeTimestamp within last 2 seconds OR every 10 seconds forced.
            const now = Date.now();
            if (!usuarioId || !currentMonthKey) return;
            const changedRecently = (now - lastChangeTimestamp) < 2000;
            const saveAnyway = (now % 10000) < 1000; // rough every ~10s
            if (!changedRecently && !saveAnyway) return;
            try {
                await saveMonthToFirestore(usuarioId, currentMonthKey);
                // clear lastChangeTimestamp to avoid continuous saves
                lastChangeTimestamp = 0;
            } catch (e) {
                console.error("Erro auto-salvando:", e);
            }
        }, 1000);
    }

    // ------------------ auth + initialization ------------------
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            // redirect is handled earlier, but keep safety
            return;
        }

        // store uid for later operations
        usuarioId = user.uid;

        // populate months list
        availableMonths = await listMonthsFromFirestore(usuarioId);

        // default selection: current month
        const defaultKey = getCurrentMonthKeyDefault();

        // if there are no months yet, create a doc for current month as "novo" (but per Op√ß√£o A, we prefer empty)
        // We'll not auto-create doc, only select it in UI and allow user to save.
        currentMonthKey = defaultKey;

        populateMonthSelect();

        // If current month exists in Firestore, load it, else leave empty or load existing page values?
        // Per your choice (Op√ß√£o A): new month starts empty ‚Äî so load from Firestore only if exists.
        if (availableMonths.includes(currentMonthKey)) {
            await loadMonth(usuarioId, currentMonthKey);
        } else {
            // start empty (Op√ß√£o A)
            debitos = [];
            rendas = [];
            atualizarTabela();
            atualizarRendas();
            populateMonthSelect();
        }

        startAutoSaveLoop();
    });

    // select change
    monthSelect.addEventListener("change", async (e) => {
        const mk = monthSelect.value;
        if (!mk) return;
        await loadMonth(usuarioId, mk);
    });

    // new month button
    newMonthBtn.addEventListener("click", async () => {
        // create empty month and select it
        const mk = await createNewMonth(usuarioId);
        if (mk) {
            alert(`M√™s ${labelFromMonthKey(mk)} criado (vazio).`);
        }
    });

    // duplicate button
    duplicateBtn.addEventListener("click", async () => {
        // ask user for target month (default to currentMonthKey)
        const defaultTarget = currentMonthKey || getCurrentMonthKeyDefault();
        const userInput = prompt("Informe o m√™s destino (YYYY-MM) para duplicar o m√™s anterior para ele:", defaultTarget);
        if (!userInput) return;
        if (!/^\d{4}-\d{2}$/.test(userInput)) {
            alert("Formato inv√°lido. Use YYYY-MM.");
            return;
        }
        await duplicatePreviousMonth(usuarioId, userInput);
    });

    // logout behavior (keep)
    if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
            try {
                await signOut(auth);
                window.location.href = "login.html";
            } catch (e) {
                console.error("Erro logout:", e);
            }
        });
    }

    // inicial render com dados atuais
    atualizarTabela();
    atualizarRendas();

    // marca altera√ß√£o sempre que o usu√°rio faz algo (safeguard)
    // contenteditable handlers already call marcarAlteracao via __editarDebito/__editarRenda
    // also observe DOM changes like adding/removing
    const originalAddDebito = document.getElementById("addDebitoBtn").onclick;
    document.getElementById("addDebitoBtn").onclick = function() { originalAddDebito(); marcarAlteracao(); };
    const originalAddRenda = document.getElementById("addRendaBtn").onclick;
    document.getElementById("addRendaBtn").onclick = function() { originalAddRenda(); marcarAlteracao(); };

</script>

</body>
</html>
