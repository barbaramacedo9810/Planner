<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Planejamento Financeiro</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- √çcones Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- SEU CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

<!-- üîê PROTE√á√ÉO DE LOGIN (colocada no topo) -->
<script type="module">
    import app, { db } from "./firebase.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const auth = getAuth(app);

    // redireciona para login caso n√£o esteja logado
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "login.html";
        }
    });
</script>
<!-- üîê FIM PROTE√á√ÉO -->

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top custom-navbar bg-white shadow-sm">
    <div class="container-fluid">

        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <i class="bi bi-journal-check" style="font-size:22px; margin-right:6px;"></i>
            Planejamento
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto">

                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="bi bi-house-door"></i> In√≠cio
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link active" href="planejamento.html">
                        <i class="bi bi-cash-stack"></i> Planejamento
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="praia.html">
                        <i class="bi bi-sun"></i> Praia
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="atrasadas.html">
                        <i class="bi bi-exclamation-triangle"></i> Atrasadas
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="calendario.html">
                        <i class="bi bi-calendar3"></i> Calend√°rio
                    </a>
                </li>

                <li class="nav-item ms-3">
                    <button id="logoutBtn" class="btn btn-danger btn-sm">Sair</button>
                </li>

            </ul>
        </div>

    </div>
</nav>

<!-- CONTE√öDO PRINCIPAL -->
<div class="main-wrapper mt-5">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Planejamento Financeiro</h1>

        <!-- seletor de m√™s + duplicar -->
        <div class="d-flex align-items-center gap-2">
            <label class="mb-0 me-1">Planejamento ‚Äî</label>
            <select id="monthSelect" class="form-select form-select-sm" style="width:220px;"></select>

            <button id="newMonthBtn" class="btn btn-outline-secondary btn-sm" title="Criar m√™s vazio">
                Novo m√™s
            </button>

            <button id="duplicateBtn" class="btn btn-outline-primary btn-sm" title="Duplicar m√™s anterior">
                Duplicar
            </button>
        </div>
    </div>

    <!-- RESUMO -->
    <div class="resumo-box shadow-sm mb-4">
        <p>Total de Sa√≠da: <strong id="resumoSaida">R$ 0,00</strong></p>
        <p>Total de Rendas: <strong id="resumoRendas">R$ 0,00</strong></p>
        <p>Saldo Final: <strong id="saldoFinal">R$ 0,00</strong></p>

        <img src="img/planejamento.png" class="img-resumo-decor">
    </div>

    <div class="row mt-4">

        <!-- ESQUERDA - TABELA -->
        <div class="col-md-8">

            <div class="d-flex justify-content-between mb-2">
                <h4 class="fw-bold">D√©bitos</h4>
                <button class="btn btn-primary btn-sm" id="addDebitoBtn">
                    <i class="bi bi-plus-circle"></i> Adicionar D√©bito
                </button>
            </div>

            <table class="table table-bordered shadow-sm" id="tabelaDebitos">
                <thead>
                <tr>
                    <th>D√©bito</th>
                    <th>Valor (R$)</th>
                    <th></th>
                </tr>
                </thead>
                <tbody></tbody>

                <tfoot>
                <tr class="table-warning fw-bold">
                    <td>Total</td>
                    <td id="totalSaida">R$ 0,00</td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>

        <!-- DIREITA - RENDAS + AFIRMA√á√ïES -->
        <div class="col-md-4">

            <div class="card renda-card shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="fw-bold d-flex justify-content-between">
                        Rendas
                        <button class="btn btn-success btn-sm" id="addRendaBtn">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </h4>

                    <div id="rendasLista"></div>

                    <!-- Total -->
                    <p class="fw-bold mt-3">Total de Entradas:
                        <span id="totalRendas" class="text-success">R$ 0,00</span>
                    </p>
                </div>
            </div>

            <!-- QUADRADO ROSA -->
            <div class="affirm-box mt-3">
                <h5 class="affirm-title">‚ú® Afirma√ß√µes Positivas</h5>

                <div class="affirm-item">
                    "A prosperidade come√ßa na mente. Cultive pensamentos positivos e veja sua realidade se transformar."
                </div>

                <div class="affirm-item">
                    "Sou merecedora de toda a abund√¢ncia que o universo tem para me oferecer."
                </div>

                <div class="affirm-item">
                    "A prosperidade flui livremente em minha vida com leveza."
                </div>

                <img src="img/planejamento1.png" class="img-affirm-decor">
            </div>

        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- ======================================================= -->
<!-- SCRIPT COMPLETO ‚Äî PLANEJAMENTO (OP√á√ÉO A)                -->
<!-- ======================================================= -->
<script type="module">
    import app, { db } from "./firebase.js";
    import {
        getAuth,
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
        collection,
        doc,
        getDoc,
        getDocs,
        setDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const auth = getAuth(app);

    /* ---------------------------------------- */
    /* NOMES DOS MESES                          */
    /* ---------------------------------------- */
    const MONTH_NAMES = [
        "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
        "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
    ];

    function labelFromKey(key) {
        const [y,m] = key.split("-");
        return `${MONTH_NAMES[Number(m)-1]} / ${y}`;
    }

    function prevMonthKey(key) {
        let [y,m] = key.split("-").map(Number);
        m--;
        if (m < 1) { m = 12; y--; }
        return `${y}-${String(m).padStart(2,"0")}`;
    }

    /* ---------------------------------------- */
    /* VARI√ÅVEIS GLOBAIS                        */
    /* ---------------------------------------- */
    let usuarioId = null;
    let availableMonths = [];
    let currentMonthKey = null;

    let debitos = [];
    let rendas = [];

    /* ---------------------------------------- */
    /* ELEMENTOS DOM                            */
    /* ---------------------------------------- */
    const tabelaBody = document.querySelector("#tabelaDebitos tbody");
    const rendasLista = document.getElementById("rendasLista");
    const monthSelect = document.getElementById("monthSelect");
    const newMonthBtn = document.getElementById("newMonthBtn");
    const duplicateBtn = document.getElementById("duplicateBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    /* ---------------------------------------- */
    /* FIRESTORE PATH ‚Äî OP√á√ÉO A                 */
    /* ---------------------------------------- */
    function colMeses(uid) {
        return collection(db, "usuarios", uid, "planejamento", "meses");
    }
    function docMes(uid, key) {
        return doc(db, "usuarios", uid, "planejamento", "meses", key);
    }

    /* ---------------------------------------- */
    /* LISTAR MESES DO FIRESTORE                */
    /* ---------------------------------------- */
    async function carregarListaMeses() {
        const snap = await getDocs(colMeses(usuarioId));
        availableMonths = [];
        snap.forEach(d => availableMonths.push(d.id));
        availableMonths.sort();
        atualizarSelect();
    }

    /* ---------------------------------------- */
    /* ATUALIZAR SELECT                         */
    /* ---------------------------------------- */
    function atualizarSelect() {
        monthSelect.innerHTML = "";

        availableMonths.forEach(key => {
            const op = document.createElement("option");
            op.value = key;
            op.textContent = labelFromKey(key);
            monthSelect.appendChild(op);
        });

        if (currentMonthKey) monthSelect.value = currentMonthKey;
    }

    /* ---------------------------------------- */
    /* CARREGAR M√äS                             */
    /* ---------------------------------------- */
    async function carregarMes(key) {
        const ref = docMes(usuarioId, key);
        const snap = await getDoc(ref);

        if (snap.exists()) {
            const data = snap.data();
            debitos = data.debitos || [];
            rendas = data.rendas || [];
        } else {
            debitos = [];
            rendas = [];
        }

        currentMonthKey = key;
        atualizarSelect();
        renderDebitos();
        renderRendas();
        atualizarTotais();
    }

    /* ---------------------------------------- */
    /* SALVAR M√äS                               */
    /* ---------------------------------------- */
    async function salvarMes() {
        if (!usuarioId || !currentMonthKey) return;

        const ref = docMes(usuarioId, currentMonthKey);
        await setDoc(ref, {
            debitos,
            rendas,
            updatedAt: new Date().toISOString()
        });

        await carregarListaMeses();
    }

    /* ---------------------------------------- */
    /* CRIAR NOVO M√äS (VAZIO)                   */
    /* ---------------------------------------- */
    async function criarNovoMes() {
        const mes = prompt("Informe o m√™s (YYYY-MM):");
        if (!mes) return;

        if (!/^\d{4}-\d{2}$/.test(mes)) {
            alert("Formato inv√°lido.");
            return;
        }

        debitos = [];
        rendas = [];
        currentMonthKey = mes;

        await salvarMes();
        await carregarMes(mes);

        alert("M√™s criado com sucesso.");
    }

    /* ---------------------------------------- */
    /* DUPLICAR M√äS ANTERIOR                    */
    /* ---------------------------------------- */
    async function duplicarMes() {
        const destino = prompt("Para qual m√™s deseja duplicar? (YYYY-MM):", currentMonthKey);
        if (!destino) return;

        if (!/^\d{4}-\d{2}$/.test(destino)) {
            alert("Formato inv√°lido.");
            return;
        }

        const origem = prevMonthKey(destino);

        const srcRef = docMes(usuarioId, origem);
        const snap = await getDoc(srcRef);

        if (!snap.exists()) {
            alert("O m√™s anterior n√£o existe.");
            return;
        }

        const data = snap.data();
        debitos = JSON.parse(JSON.stringify(data.debitos || []));
        rendas = JSON.parse(JSON.stringify(data.rendas || []));

        currentMonthKey = destino;
        await salvarMes();
        await carregarMes(destino);

        alert(`M√™s ${labelFromKey(origem)} duplicado para ${labelFromKey(destino)}`);
    }

    /* ---------------------------------------- */
    /* RENDERIZA√á√ÉO TABELAS                     */
    /* ---------------------------------------- */

    function renderDebitos() {
        tabelaBody.innerHTML = "";

        debitos.forEach((d, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td contenteditable="true" oninput="window.__edDeb(${i}, 'nome', this.innerText)">${d.nome}</td>
                <td contenteditable="true" oninput="window.__edDeb(${i}, 'valor', this.innerText)">${Number(d.valor).toFixed(2)}</td>
                <td class="text-center">
                    <button class="btn btn-danger btn-sm" onclick="window.__rmDeb(${i})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tabelaBody.appendChild(tr);
        });

        atualizarTotais();
    }

    function renderRendas() {
        rendasLista.innerHTML = "";

        rendas.forEach((r, i) => {
            const div = document.createElement("div");
            div.className = "d-flex justify-content-between align-items-center mb-2";

            div.innerHTML = `
                <div contenteditable="true" oninput="window.__edRen(${i}, 'nome', this.innerText)">${r.nome}</div>

                <div>
                    <span contenteditable="true" oninput="window.__edRen(${i}, 'valor', this.innerText)">
                        ${Number(r.valor).toFixed(2)}
                    </span>
                    <button class="btn btn-danger btn-sm ms-2" onclick="window.__rmRen(${i})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            rendasLista.appendChild(div);
        });

        atualizarTotais();
    }

    /* ---------------------------------------- */
    /* FUN√á√ïES GLOBAIS PARA EDITAR              */
    /* ---------------------------------------- */
    window.__edDeb = (i, c, v) => {
        if (c === "valor") v = parseFloat(v.replace(",", ".")) || 0;
        debitos[i][c] = v;
        salvarMes();
        atualizarTotais();
    };

    window.__rmDeb = (i) => {
        debitos.splice(i,1);
        salvarMes();
        renderDebitos();
    };

    window.__edRen = (i, c, v) => {
        if (c === "valor") v = parseFloat(v.replace(",", ".")) || 0;
        rendas[i][c] = v;
        salvarMes();
        atualizarTotais();
    };

    window.__rmRen = (i) => {
        rendas.splice(i,1);
        salvarMes();
        renderRendas();
    };

    /* ---------------------------------------- */
    /* + BOT√ïES                                 */
    /* ---------------------------------------- */
    document.getElementById("addDebitoBtn").onclick = () => {
        debitos.push({ nome: "Novo D√©bito", valor: 0 });
        salvarMes();
        renderDebitos();
    };

    document.getElementById("addRendaBtn").onclick = () => {
        rendas.push({ nome: "Nova Renda", valor: 0 });
        salvarMes();
        renderRendas();
    };

    newMonthBtn.onclick = criarNovoMes;
    duplicateBtn.onclick = duplicarMes;

    logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = "login.html";
    };

    /* ---------------------------------------- */
    /* AO FAZER LOGIN                            */
    /* ---------------------------------------- */
    onAuthStateChanged(auth, async user => {
        if (!user) return;
        usuarioId = user.uid;

        // carrega lista
        await carregarListaMeses();

        // se n√£o houver meses, s√≥ deixa o select vazio
        if (availableMonths.length > 0) {
            currentMonthKey = availableMonths[availableMonths.length - 1];
            await carregarMes(currentMonthKey);
        }
    });

</script>

/* ===========================
PARTE 3 ‚Äî Atualiza√ß√µes finais
=========================== */

/* ---------------------------------------- */
/* UTILIT√ÅRIOS                             */
/* ---------------------------------------- */
function formatBRL(value) {
// valor num√©rico -> string "R$ 1.234,56"
const n = Number(value) || 0;
return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

/* ---------------------------------------- */
/* ATUALIZAR TOTAIS                         */
/* ---------------------------------------- */
function atualizarTotais() {
const totalSaidaVal = debitos.reduce((acc, d) => acc + (Number(d.valor) || 0), 0);
const totalRendasVal = rendas.reduce((acc, r) => acc + (Number(r.valor) || 0), 0);
const saldoVal = totalRendasVal - totalSaidaVal;

// atualiza UI
document.getElementById("totalSaida").innerText = formatBRL(totalSaidaVal);
document.getElementById("totalRendas").innerText = formatBRL(totalRendasVal);
document.getElementById("resumoSaida").innerText = formatBRL(totalSaidaVal);
document.getElementById("resumoRendas").innerText = formatBRL(totalRendasVal);
document.getElementById("saldoFinal").innerText = formatBRL(saldoVal);
document.getElementById("totalRendas").innerText = formatBRL(totalRendasVal);

// destaca cor do saldo
const saldoEl = document.getElementById("saldoFinal");
if (saldoVal < 0) {
saldoEl.classList.remove("text-success");
saldoEl.classList.add("text-danger");
} else {
saldoEl.classList.remove("text-danger");
saldoEl.classList.add("text-success");
}
}

/* ---------------------------------------- */
/* HANDLERS SELECT M√äS                      */
/* ---------------------------------------- */
monthSelect.onchange = async () => {
const key = monthSelect.value;
if (!key) return;
// salva o m√™s atual antes de trocar (evita perda de dados se houver mudan√ßas)
await salvarMes();
await carregarMes(key);
};

/* ---------------------------------------- */
/* CRIAR M√äS ATUAL SE N√ÉO HOUVER NENHUM     */
/* ---------------------------------------- */
async function garantirMesPadrao() {
if (availableMonths.length > 0) return;

const hoje = new Date();
const y = hoje.getFullYear();
const m = String(hoje.getMonth() + 1).padStart(2, "0");
const chave = `${y}-${m}`;

// cria m√™s padr√£o vazio sem perguntar
debitos = [];
rendas = [];
currentMonthKey = chave;
await salvarMes();
await carregarListaMeses();
await carregarMes(chave);
}

/* ---------------------------------------- */
/* MELHORIAS: ESCUTAR ALTERA√á√ïES INLINE     */
/* ---------------------------------------- */
/* j√° usamos oninput nos elementos contenteditable apontando
para window.__edDeb / __edRen ‚Äî essas fun√ß√µes j√° chamam salvarMes() */

/* ---------------------------------------- */
/* AO FAZER LOGIN ‚Äî melhorar fluxo inicial  */
/* ---------------------------------------- */
onAuthStateChanged(auth, async user => {
if (!user) return;
usuarioId = user.uid;

// carrega lista
await carregarListaMeses();

// se n√£o houver meses, cria um m√™s padr√£o (m√™s atual)
if (availableMonths.length === 0) {
await garantirMesPadrao();
return;
}

// se j√° havia meses, seleciona o √∫ltimo (mais recente)
if (!currentMonthKey) {
currentMonthKey = availableMonths[availableMonths.length - 1];
}

// carrega o m√™s atual selecionado
await carregarMes(currentMonthKey);
});

/* ---------------------------------------- */
/* SALVAR PERI√ìDICO (opcional)              */
/* ---------------------------------------- */
/* Se quiser, voc√™ pode salvar automaticamente periodicamente.
Abaixo est√° apenas um exemplo comentado ‚Äî ative se desejar:

setInterval(() => {
if (usuarioId && currentMonthKey) {
salvarMes().catch(console.error);
}
}, 1000 * 30); // a cada 30s
*/

/* ---------------------------------------- */
/* FIM ‚Äî garantir render inicial correto    */
/* ---------------------------------------- */
// caso a p√°gina j√° tenha sido carregada e o usu√°rio esteja logado,
// onAuthStateChanged ser√° chamado; se quiser for√ßar alguma coisa
// ao final do script, pode descomentar o trecho abaixo:
// atualizarTotais();

/* ------------------------------
EOF ‚Äî Parte 3
------------------------------ */
