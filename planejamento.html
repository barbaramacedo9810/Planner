<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Planejamento Financeiro</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- √çcones Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- SEU CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top custom-navbar bg-white shadow-sm">
    <div class="container-fluid">

        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <i class="bi bi-journal-check" style="font-size:22px; margin-right:6px;"></i>
            Planejamento
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto">

                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="bi bi-house-door"></i> In√≠cio
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link active" href="planejamento.html">
                        <i class="bi bi-cash-stack"></i> Planejamento
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="praia.html">
                        <i class="bi bi-sun"></i> Praia
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="atrasadas.html">
                        <i class="bi bi-exclamation-triangle"></i> Atrasadas
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="calendario.html">
                        <i class="bi bi-calendar3"></i> Calend√°rio
                    </a>
                </li>

                <li class="nav-item ms-3">
                    <button id="logoutBtn" class="btn btn-danger btn-sm">Sair</button>
                </li>

            </ul>
        </div>

    </div>
</nav>

<!-- CONTE√öDO PRINCIPAL -->
<div class="main-wrapper mt-5">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Planejamento Financeiro</h1>
        <p class="mes">M√™s: <span class="text-primary fw-bold">DEZEMBRO</span></p>
    </div>

    <!-- RESUMO -->
    <div class="resumo-box shadow-sm mb-4">
        <p>Total de Sa√≠da: <strong id="resumoSaida">R$ 0,00</strong></p>
        <p>Total de Rendas: <strong id="resumoRendas">R$ 0,00</strong></p>
        <p>Saldo Final: <strong id="saldoFinal">R$ 0,00</strong></p>

        <img src="img/planejamento.png" class="img-resumo-decor">
    </div>

    <div class="row mt-4">

        <!-- ESQUERDA - TABELA -->
        <div class="col-md-8">

            <div class="d-flex justify-content-between mb-2">
                <h4 class="fw-bold">D√©bitos</h4>
                <button class="btn btn-primary btn-sm" id="addDebitoBtn">
                    <i class="bi bi-plus-circle"></i> Adicionar D√©bito
                </button>
            </div>

            <table class="table table-bordered shadow-sm" id="tabelaDebitos">
                <thead>
                <tr>
                    <th>D√©bito</th>
                    <th>Valor (R$)</th>
                    <th></th>
                </tr>
                </thead>
                <tbody></tbody>

                <tfoot>
                <tr class="table-warning fw-bold">
                    <td>Total</td>
                    <td id="totalSaida">R$ 0,00</td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>

        <!-- DIREITA - RENDAS + AFIRMA√á√ïES -->
        <div class="col-md-4">

            <div class="card renda-card shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="fw-bold d-flex justify-content-between">
                        Rendas
                        <button class="btn btn-success btn-sm" id="addRendaBtn">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </h4>

                    <div id="rendasLista"></div>

                    <!-- Total -->
                    <p class="fw-bold mt-3">Total de Entradas:
                        <span id="totalRendas" class="text-success">R$ 0,00</span>
                    </p>
                </div>
            </div>

            <!-- QUADRADO ROSA -->
            <div class="affirm-box mt-3">
                <h5 class="affirm-title">‚ú® Afirma√ß√µes Positivas</h5>

                <div class="affirm-item">
                    "A prosperidade come√ßa na mente. Cultive pensamentos positivos e veja sua realidade se transformar."
                </div>

                <div class="affirm-item">
                    "Sou merecedora de toda a abund√¢ncia que o universo tem para me oferecer."
                </div>

                <div class="affirm-item">
                    "A prosperidade flui livremente em minha vida com leveza."
                </div>

                <img src="img/planejamento1.png" class="img-affirm-decor">
            </div>

        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- ======================================================= -->
<!-- SCRIPT COMPLETO - TUDO DIN√ÇMICO                         -->
<!-- ======================================================= -->
<script>
    /* --------------------------------------------- */
    /*               D E B I T O S                   */
    /* --------------------------------------------- */

    let debitos = [
        { nome: "Luz", valor: 300 },
        { nome: "Cart√£o", valor: 800 },
        { nome: "Internet", valor: 120 },
        { nome: "Ra√ß√£o Pets", valor: 300 },
        { nome: "Netflix", valor: 22.90 },
        { nome: "Disney", valor: 27.90 },
        { nome: "Xbox", valor: 59.90 },
        { nome: "V√¥", valor: 150 },
        { nome: "Amigo", valor: 150 },
        { nome: "Pai", valor: 50 },
        { nome: "Tia", valor: 100 },
        { nome: "Tio", valor: 70 },
        { nome: "Plantas", valor: 180 },
        { nome: "Faculdade", valor: 600 },
        { nome: "Mercado", valor: 600 },
        { nome: "Carne", valor: 200 }
    ];

    let rendas = [
        { nome: "Renda 1", valor: 1320 },
        { nome: "Renda 2", valor: 1055 },
        { nome: "Renda 3", valor: 830 },
        { nome: "Renda 4", valor: 280 }
    ];

    const tabelaBody = document.querySelector("#tabelaDebitos tbody");
    const listaRendas = document.getElementById("rendasLista");

    function atualizarTabela() {
        tabelaBody.innerHTML = "";

        debitos.forEach((item, index) => {
            let tr = document.createElement("tr");

            tr.innerHTML = `
            <td contenteditable="true" oninput="editarDebito(${index}, 'nome', this.innerText)">
                ${item.nome}
            </td>

            <td contenteditable="true" oninput="editarDebito(${index}, 'valor', this.innerText)">
                ${item.valor.toFixed(2)}
            </td>

            <td class="text-center">
                <button class="btn btn-danger btn-sm" onclick="removerDebito(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;

            tabelaBody.appendChild(tr);
        });

        atualizarTotais();
    }

    function editarDebito(i, campo, valor) {
        if (campo === "valor") valor = valor.replace(",", ".");
        if (campo === "valor") valor = parseFloat(valor) || 0;
        debitos[i][campo] = valor;
        atualizarTotais();
    }

    function removerDebito(index) {
        debitos.splice(index, 1);
        atualizarTabela();
    }

    document.getElementById("addDebitoBtn").onclick = () => {
        debitos.push({ nome: "Novo D√©bito", valor: 0 });
        atualizarTabela();
    };

    /* --------------------------------------------- */
    /*                 R E N D A S                   */
    /* --------------------------------------------- */

    function atualizarRendas() {
        listaRendas.innerHTML = "";

        rendas.forEach((item, index) => {
            let div = document.createElement("div");
            div.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

            div.innerHTML = `
            <div contenteditable="true" oninput="editarRenda(${index}, 'nome', this.innerText)">
                ${item.nome}
            </div>

            <div class="d-flex align-items-center">
                <span contenteditable="true" oninput="editarRenda(${index}, 'valor', this.innerText)">
                    ${item.valor.toFixed(2)}
                </span>

                <button class="btn btn-danger btn-sm ms-2" onclick="removerRenda(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;

            listaRendas.appendChild(div);
        });

        atualizarTotais();
    }

    function editarRenda(i, campo, valor) {
        if (campo === "valor") valor = valor.replace(",", ".");
        if (campo === "valor") valor = parseFloat(valor) || 0;
        rendas[i][campo] = valor;
        atualizarTotais();
    }

    function removerRenda(index) {
        rendas.splice(index, 1);
        atualizarRendas();
    }

    document.getElementById("addRendaBtn").onclick = () => {
        rendas.push({ nome: "Nova Renda", valor: 0 });
        atualizarRendas();
    };

    /* --------------------------------------------- */
    /*            C√ÅLCULO DOS TOTAIS                 */
    /* --------------------------------------------- */

    function atualizarTotais() {
        let totalDebitos = debitos.reduce((t, d) => t + d.valor, 0);
        let totalRenda = rendas.reduce((t, r) => t + r.valor, 0);
        let saldo = totalRenda - totalDebitos;

        document.getElementById("totalSaida").innerText =
            "R$ " + totalDebitos.toFixed(2).replace(".", ",");

        document.getElementById("resumoSaida").innerText =
            "R$ " + totalDebitos.toFixed(2).replace(".", ",");

        document.getElementById("totalRendas").innerText =
            "R$ " + totalRenda.toFixed(2).replace(".", ",");

        document.getElementById("resumoRendas").innerText =
            "R$ " + totalRenda.toFixed(2).replace(".", ",");

        document.getElementById("saldoFinal").innerText =
            "R$ " + saldo.toFixed(2).replace(".", ",");
    }

    /* --------------------------------------------- */
    /*   INICIAR TELA                                 */
    /* --------------------------------------------- */
    atualizarTabela();
    atualizarRendas();
</script>

<!-- üîê PROTE√á√ÉO DE LOGIN -->
<script type="module">
    import app from "./firebase.js";
    import { getAuth, onAuthStateChanged }
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "login.html";
        }
    });
</script>

<!-- üî• FIREBASE ‚Äì SALVAR E CARREGAR DADOS DO USU√ÅRIO -->
<script type="module">
    import app from "./firebase.js";
    import {
        getAuth,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
        getFirestore,
        doc,
        setDoc,
        getDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    let usuarioId = null;

    /* -------------------------------------------------- */
    /*      QUANDO O USU√ÅRIO LOGAR, CARREGAR DADOS        */
    /* -------------------------------------------------- */
    onAuthStateChanged(auth, async (user) => {

        if (!user) {
            window.location.href = "login.html";
            return;
        }

        usuarioId = user.uid;

        const ref = doc(db, "planejamento", usuarioId);
        const snap = await getDoc(ref);

        if (snap.exists()) {
            const dados = snap.data();

            // üîπ S√≥ substitu√≠mos SE existirem no Firestore
            if (dados.debitos) debitos = dados.debitos;
            if (dados.rendas) rendas = dados.rendas;

            atualizarTabela();
            atualizarRendas();
        }

        // Sempre que editar, salvar no banco
        ativarAutoSave();
    });

    /* -------------------------------------------------- */
    /*                   AUTO-SALVAMENTO                  */
    /* -------------------------------------------------- */

    function ativarAutoSave() {

        // Salva 1x por segundo (evita spam no Firestore)
        setInterval(() => {
            if (!usuarioId) return;

            const ref = doc(db, "planejamento", usuarioId);

            setDoc(ref, {
                debitos: debitos,
                rendas: rendas
            }, { merge: true });

        }, 1000);
    }
</script>

</body>
</html>
