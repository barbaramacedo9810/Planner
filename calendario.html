<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Calend√°rio</title>

    <!-- BOOTSTRAP -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- FULLCALENDAR -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">

    <!-- ICONES -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body { padding-top: 80px; }
        #calendar { border-radius: 12px; }
        .fc-event { border-radius: 6px; padding: 3px 6px; font-size: 0.85rem; }
    </style>

    <link rel="stylesheet" href="css/responsive.css">
</head>

<body class="bg-light">

<!-- üîê PROTE√á√ÉO -->
<script type="module">
    import app from "./firebase.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const auth = getAuth(app);
    onAuthStateChanged(auth, user => {
        if (!user) window.location.href = "index.html";
    });
</script>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top custom-navbar bg-white shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="index.html">
            <i class="bi bi-journal-check" style="font-size:22px; margin-right:6px;"></i>
            Planejamento
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-house-door"></i> In√≠cio</a></li>
                <li class="nav-item"><a class="nav-link" href="planejamento.html"><i class="bi bi-cash-stack"></i> Planejamento</a></li>
                <li class="nav-item"><a class="nav-link active" href="praia.html"><i class="bi bi-sun"></i> Praia</a></li>
                <li class="nav-item"><a class="nav-link" href="atrasadas.html"><i class="bi bi-exclamation-triangle"></i> Atrasadas</a></li>
                <li class="nav-item"><a class="nav-link" href="calendario.html"><i class="bi bi-calendar3"></i> Calend√°rio</a></li>
                <li class="nav-item"><a class="nav-link" href="perfil.html"><i class="bi bi-person-circle"></i> Perfil</a></li>

                <img id="navUserPhoto" class="rounded-circle ms-3"
                     src="img/login.png" width="38" height="38"
                     style="object-fit:cover; border:2px solid #ddd;">

                <li class="nav-item ms-3">
                    <button id="logoutBtn" class="btn btn-danger btn-sm">Sair</button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2 class="text-center mb-4">Calend√°rio</h2>
    <div id="calendar" class="bg-white p-3 rounded shadow"></div>
</div>

<!-- MODAL -->
<div class="modal fade" id="eventModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Evento</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="event-id">

                <label class="form-label">T√≠tulo</label>
                <input type="text" id="event-title" class="form-control mb-2">

                <label class="form-label">Data inicial</label>
                <input type="date" id="event-start" class="form-control mb-2">

                <label class="form-label">Hora inicial</label>
                <input type="time" id="event-start-time" class="form-control mb-2">

                <label class="form-label">Data final</label>
                <input type="date" id="event-end" class="form-control mb-2">

                <label class="form-label">Hora final</label>
                <input type="time" id="event-end-time" class="form-control mb-2">

                <label class="form-label">Tipo do evento</label>
                <select id="event-type" class="form-select mb-2">
                    <option value="trabalho">Trabalho</option>
                    <option value="pessoal">Pessoal</option>
                    <option value="viagem">Viagem</option>
                    <option value="estudo">Estudo</option>
                </select>

                <label class="form-label">Cor do evento</label>
                <input type="color" id="event-color" class="form-control form-control-color mb-2">
            </div>

            <div class="modal-footer">
                <button id="delete-event" class="btn btn-danger me-auto">Excluir</button>
                <button id="save-event" class="btn btn-primary">Salvar</button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>

        </div>
    </div>
</div>

<!-- BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- FULLCALENDAR JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<!-- SCRIPT -->
<script type="module">
    import app from "./firebase.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const auth = getAuth(app);
    const db = getFirestore(app);

    let usuarioId = null;
    let calendar = null;

    const coresPorTipo = {
        trabalho: "#0d6efd",
        pessoal: "#198754",
        viagem: "#fd7e14",
        estudo: "#6f42c1"
    };

    // Fun√ß√£o para ajustar cor do texto conforme cor de fundo
    function ajustarCorTextoEvento(corFundo) {
        const r = parseInt(corFundo.substr(1,2),16);
        const g = parseInt(corFundo.substr(3,2),16);
        const b = parseInt(corFundo.substr(5,2),16);
        const luminancia = 0.2126*r + 0.7152*g + 0.0722*b;
        return luminancia < 128 ? "white" : "black";
    }

    onAuthStateChanged(auth, async user => {
        if (!user) return;

        usuarioId = user.uid;
        document.getElementById("navUserPhoto").src = user.photoURL || "img/login.png";
        document.getElementById("logoutBtn").onclick = () => signOut(auth);

        carregarCalendario();
    });

    async function carregarCalendario() {

        const modal = new bootstrap.Modal(document.getElementById("eventModal"));

        const elId = document.getElementById("event-id");
        const elTitle = document.getElementById("event-title");
        const elStart = document.getElementById("event-start");
        const elStartTime = document.getElementById("event-start-time");
        const elEnd = document.getElementById("event-end");
        const elEndTime = document.getElementById("event-end-time");
        const elType = document.getElementById("event-type");
        const elColor = document.getElementById("event-color");
        const btnSave = document.getElementById("save-event");
        const btnDelete = document.getElementById("delete-event");

        // Atualiza a cor do texto no modal instantaneamente quando muda a cor
        elColor.addEventListener("input", () => {
            elTitle.style.color = ajustarCorTextoEvento(elColor.value);
        });

        const eventos = [];
        const snap = await getDocs(collection(db, `usuarios/${usuarioId}/eventos`));
        snap.forEach(d => eventos.push({ id: d.id, ...d.data() }));

        calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
            locale: "pt-br",
            initialView: "dayGridMonth",
            headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,timeGridWeek,timeGridDay" },
            selectable: true,
            editable: true,
            dayMaxEvents: true,
            events: eventos,

            dateClick(info) {
                elId.value = "";
                elTitle.value = "";
                elStart.value = info.dateStr;
                elEnd.value = info.dateStr;
                elStartTime.value = "08:00";
                elEndTime.value = "09:00";
                elType.value = "trabalho";
                elColor.value = coresPorTipo.trabalho;
                elTitle.style.color = ajustarCorTextoEvento(elColor.value);
                btnDelete.style.display = "none";
                modal.show();
            },

            eventClick(info) {
                const e = info.event;
                elId.value = e.id;
                elTitle.value = e.title;
                elStart.value = e.startStr.slice(0, 10);
                elStartTime.value = e.startStr.slice(11, 16);
                elEnd.value = e.endStr.slice(0, 10);
                elEndTime.value = e.endStr.slice(11, 16);
                elType.value = e.extendedProps.tipo || "trabalho";
                elColor.value = e.backgroundColor || coresPorTipo[elType.value];
                elTitle.style.color = ajustarCorTextoEvento(elColor.value);
                btnDelete.style.display = "inline-block";
                modal.show();
            },

            eventDidMount(info) {
                info.el.style.color = ajustarCorTextoEvento(info.event.backgroundColor || "#ffffff");
            }
        });

        calendar.render();

        btnSave.onclick = async () => {
            const id = elId.value;
            const title = elTitle.value.trim();
            if (!title) return alert("Digite um t√≠tulo");

            const data = {
                title,
                start: `${elStart.value}T${elStartTime.value}`,
                end: `${elEnd.value}T${elEndTime.value}`,
                tipo: elType.value,
                color: elColor.value
            };

            if (!id) {
                const ref = await addDoc(collection(db, `usuarios/${usuarioId}/eventos`), data);
                const ev = calendar.addEvent({ id: ref.id, ...data });
                ev.setProp("textColor", ajustarCorTextoEvento(data.color));
            } else {
                await updateDoc(doc(db, `usuarios/${usuarioId}/eventos/${id}`), data);
                const ev = calendar.getEventById(id);
                ev.setProp("title", data.title);
                ev.setStart(data.start);
                ev.setEnd(data.end);
                ev.setProp("color", data.color);
                ev.setProp("textColor", ajustarCorTextoEvento(data.color));
            }

            modal.hide();
        };

        btnDelete.onclick = async () => {
            const id = elId.value;
            await deleteDoc(doc(db, `usuarios/${usuarioId}/eventos/${id}`));
            calendar.getEventById(id)?.remove();
            modal.hide();
        };
    }
</script>

</body>
</html>
